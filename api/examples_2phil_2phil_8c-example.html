<!-- HTML header for doxygen 1.9.1-->
<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<!--<meta charset="utf-8">-->
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CNDP: examples/phil/phil.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="/assets/css/styles.css" rel="stylesheet" type="text/css" />
<link href="/assets/css/custom_doxygen.css" rel="stylesheet" type="text/css" />
<link href="/assets/images/favicon.png" rel="icon" type="image/x-icon">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
</head>
<body>
<nav class="navbar navbar-expand-md navbar-dark bg-blue px-2">
  <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <a class="navbar-brand" href="/" aria-label="CNDP">
    <img src="/assets/images/CNDP_logo_tiny.png" alt="CNDP">
  </a>
  <div class="collapse navbar-collapse" id="navbarSupportedContent">
    <div class="navbar-nav mr-auto">
      <a class="nav-link header-link" href="/blog/">Blog</a>
      <a class="nav-link header-link" href="/community/">Community</a>
      <a class="nav-link header-link" href="/dev/">Development</a>
      <a class="nav-link header-link" href="/doc/">Documentation</a>
    </div>
    <div class="navbar-nav ms-auto me-3">
      <a class="nav-link header-link" href="https://github.com/CloudNativeDataPlane/cndp">
        <svg xmlns="http://www.w3.org/2000/svg" class="navbar-nav-svg"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
      </a>
    </div>
  </div>
</nav>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">CNDP
   &#160;<span id="projectnumber">22.04.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('examples_2phil_2phil_8c-example.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">examples/phil/phil.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/* SPDX-License-Identifier: BSD-3-Clause</span></div>
<div class="line"><span class="comment"> * Copyright (c) 2019-2022 Intel Corporation</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* phil.c - Dining Philosophers problem */</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Includes */</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;inttypes.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/types.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/queue.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;netinet/in.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;setjmp.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdarg.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;ctype.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;errno.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;getopt.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;termios.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdbool.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cne__log_8h.html">cne_log.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cne__tailq_8h.html">cne_tailq.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cne__common_8h.html">cne_common.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cne__cycles_8h.html">cne_cycles.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cne__prefetch_8h.html">cne_prefetch.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cne__system_8h.html">cne_system.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cne__per__thread_8h.html">cne_per_thread.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cne__branch__prediction_8h.html">cne_branch_prediction.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cne__timer_8h.html">cne_timer.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cne__spinlock_8h.html">cne_spinlock.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cne_8h.html">cne.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;ctx.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cthread.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cthread__api_8h.html">cthread_api.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cthread_barrier.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;cthread_once.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;main.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;phil.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// clang-format off</span></div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> *doing_str[] = {</div>
<div class="line">    <span class="stringliteral">&quot;  thinking..........&quot;</span>,        <span class="comment">// 0</span></div>
<div class="line">    <span class="stringliteral">&quot;  wants to eat......&quot;</span>,        <span class="comment">// 1</span></div>
<div class="line">    <span class="stringliteral">&quot;  wait for forks....&quot;</span>,        <span class="comment">// 2</span></div>
<div class="line">    <span class="stringliteral">&quot;  eating............&quot;</span>,        <span class="comment">// 3</span></div>
<div class="line">    <span class="stringliteral">&quot;  ask right fork....&quot;</span>,        <span class="comment">// 4</span></div>
<div class="line">    <span class="stringliteral">&quot;  wait right fork...&quot;</span>,        <span class="comment">// 5</span></div>
<div class="line">    <span class="stringliteral">&quot;  ask left fork.....&quot;</span>,        <span class="comment">// 6</span></div>
<div class="line">    <span class="stringliteral">&quot;  wait left fork....&quot;</span>,        <span class="comment">// 7</span></div>
<div class="line">    <span class="stringliteral">&quot;  give all forks....&quot;</span>,        <span class="comment">// 8</span></div>
<div class="line">    <span class="stringliteral">&quot;  ------------------&quot;</span>,        <span class="comment">// 9</span></div>
<div class="line">    NULL</div>
<div class="line">};</div>
<div class="line"><span class="comment">// clang-format on</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>cthread_barrier **barriers;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keywordtype">int</span> phil_quit = 0;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line">phil_create_barriers(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> max_threads = <a name="a0"></a><a class="code" href="cne_8h.html#a2c459c8e32edf901e224424846b84763">cne_max_threads</a>();</div>
<div class="line"> </div>
<div class="line">    barriers = calloc(max_threads, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> cthread_barrier *));</div>
<div class="line">    <span class="keywordflow">if</span> (!barriers)</div>
<div class="line">        <a name="a1"></a><a class="code" href="cne__log_8h.html#a1d0beb10fedcde55b30a10c41e565045">CNE_RET</a>(<span class="stringliteral">&quot;Unable to allocate cthread_barrier structures\n&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*******************************************************************************</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * forks_get - Get the right-hand and left-hand pair of forks</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * This routine attempts to acquire the forks a philosopher needs to be able to</span></div>
<div class="line"><span class="comment"> * eat. Forks are always acquired in pair, i.e. if only one of the forks is</span></div>
<div class="line"><span class="comment"> * available then no fork is acquired.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * RETURNS: TRUE if both forks are acquired, FALSE otherwise.</span></div>
<div class="line"><span class="comment"> * ERRNO: N/A</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * \NOMANUAL</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> BOOL</div>
<div class="line">forks_get(phil_info_t *phil, <span class="keywordtype">int</span> my_num, <span class="comment">/* Philosopher&#39;s order number */</span></div>
<div class="line">          <span class="keywordtype">int</span> solution,                  <span class="comment">/* Solution to execute */</span></div>
<div class="line">          fork_attr_t *forks_attr)       <span class="comment">/* Forks attributes */</span></div>
<div class="line">{</div>
<div class="line">    BOOL forks_acquired = <span class="keyword">false</span>;</div>
<div class="line">    BOOL pass_turn      = <span class="keyword">false</span>;</div>
<div class="line">    <span class="keywordtype">int</span> right_fork      = my_num;</div>
<div class="line">    <span class="keywordtype">int</span> left_fork       = (my_num + 1) % forks_attr-&gt;num_forks;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Acquire the mutex protecting the critical section */</span></div>
<div class="line"> </div>
<div class="line">    phil-&gt;saved_count = 3;</div>
<div class="line">    <a name="a2"></a><a class="code" href="cthread__api_8h.html#a2282be9fe60bd26e3489b0f8f6a890ec">cthread_mutex_lock</a>(forks_attr-&gt;fork_mutex);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (solution == TICKET_BASED) {</div>
<div class="line">        <span class="comment">/* Check whether it is this philosopher&#39;s turn to get the forks */</span></div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (((forks_attr-&gt;forks[right_fork].philosopher == my_num) ||</div>
<div class="line">             (forks_attr-&gt;forks[right_fork].philosopher == NOBODY)) &amp;&amp;</div>
<div class="line">            ((forks_attr-&gt;forks[left_fork].philosopher == my_num) ||</div>
<div class="line">             (forks_attr-&gt;forks[left_fork].philosopher == NOBODY)))</div>
<div class="line">            forks_acquired = <span class="keyword">true</span>;</div>
<div class="line">    } <span class="keywordflow">else</span> { <span class="comment">/* Claim-based solution */</span></div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * A fork can be acquired only if it is not in use and if no one else</span></div>
<div class="line"><span class="comment">         * has claimed it. If the fork is in use already then the philosopher</span></div>
<div class="line"><span class="comment">         * simply claims it and waits for it to be available. If the fork is</span></div>
<div class="line"><span class="comment">         * available but has already been claimed then the philosopher must</span></div>
<div class="line"><span class="comment">         * wait for his/her turn.</span></div>
<div class="line"><span class="comment">         *</span></div>
<div class="line"><span class="comment">         * Note: if we were to randomize the think time of the philosophers it</span></div>
<div class="line"><span class="comment">         *       might be more efficient for a philosopher to claim the fork</span></div>
<div class="line"><span class="comment">         *       when the fork is available but has been claimed by the other</span></div>
<div class="line"><span class="comment">         *       philosopher (i.e. implement a two-slot queue for the fork).</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (forks_attr-&gt;forks[right_fork].status == FORK_IN_USE) {</div>
<div class="line">            forks_attr-&gt;forks[right_fork].philosopher = my_num;</div>
<div class="line">            pass_turn                                 = <span class="keyword">true</span>;</div>
<div class="line">            phil-&gt;saved_doing                         = PHIL_ASK_RIGHT_FORK;</div>
<div class="line">        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((forks_attr-&gt;forks[right_fork].philosopher != my_num) &amp;&amp;</div>
<div class="line">                   (forks_attr-&gt;forks[right_fork].philosopher != NOBODY)) {</div>
<div class="line">            pass_turn = <span class="keyword">true</span>;</div>
<div class="line"> </div>
<div class="line">            phil-&gt;saved_doing = PHIL_WAIT_RIGHT_FORK;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (forks_attr-&gt;forks[left_fork].status == FORK_IN_USE) {</div>
<div class="line">            forks_attr-&gt;forks[left_fork].philosopher = my_num;</div>
<div class="line">            pass_turn                                = <span class="keyword">true</span>;</div>
<div class="line"> </div>
<div class="line">            phil-&gt;saved_doing = PHIL_ASK_LEFT_FORK;</div>
<div class="line">        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((forks_attr-&gt;forks[left_fork].philosopher != my_num) &amp;</div>
<div class="line">                   (forks_attr-&gt;forks[left_fork].philosopher != NOBODY)) {</div>
<div class="line">            pass_turn = <span class="keyword">true</span>;</div>
<div class="line"> </div>
<div class="line">            phil-&gt;saved_doing = PHIL_WAIT_LEFT_FORK;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * if both forks are available and claimed by no one else then the</span></div>
<div class="line"><span class="comment">         * philosopher may acquire them.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (!pass_turn) {</div>
<div class="line">            forks_attr-&gt;forks[right_fork].status      = FORK_IN_USE;</div>
<div class="line">            forks_attr-&gt;forks[left_fork].status       = FORK_IN_USE;</div>
<div class="line">            forks_attr-&gt;forks[right_fork].philosopher = NOBODY;</div>
<div class="line">            forks_attr-&gt;forks[left_fork].philosopher  = NOBODY;</div>
<div class="line"> </div>
<div class="line">            forks_acquired = <span class="keyword">true</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Release the mutex protecting the critical section */</span></div>
<div class="line"> </div>
<div class="line">    phil-&gt;saved_count = PHIL_ASK_RIGHT_FORK;</div>
<div class="line">    <a name="a3"></a><a class="code" href="cthread__api_8h.html#a82f7feccbed077f56e9c05e45d6978a0">cthread_mutex_unlock</a>(forks_attr-&gt;fork_mutex);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> forks_acquired;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*******************************************************************************</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * forks_put - Put down the right-hand and left-hand pair of forks</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * This routine simply releases the forks a philosopher was using to eat.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * RETURNS: N/A</span></div>
<div class="line"><span class="comment"> * ERRNO: N/A</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * \NOMANUAL</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">forks_put(phil_info_t *phil, <span class="keywordtype">int</span> my_num, <span class="comment">/* Philosopher&#39;s order number */</span></div>
<div class="line">          <span class="keywordtype">int</span> solution,                  <span class="comment">/* Solution to execute */</span></div>
<div class="line">          fork_attr_t *forks_attr)       <span class="comment">/* Forks attributes*/</span></div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> right_fork = my_num;</div>
<div class="line">    <span class="keywordtype">int</span> left_fork  = (my_num + 1) % forks_attr-&gt;num_forks;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Acquire the mutex protecting the critical section */</span></div>
<div class="line">    phil-&gt;saved_count = PHIL_WAIT_RIGHT_FORK;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="cthread__api_8h.html#a2282be9fe60bd26e3489b0f8f6a890ec">cthread_mutex_lock</a>(forks_attr-&gt;fork_mutex);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (solution == TICKET_BASED) {</div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * The forks are handed over to the philosophers on the immediate right</span></div>
<div class="line"><span class="comment">         * and immediate left of the philosopher that is done eating.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line"> </div>
<div class="line">        forks_attr-&gt;forks[right_fork].philosopher =</div>
<div class="line">            (right_fork ? right_fork - 1 : (forks_attr-&gt;num_forks - 1));</div>
<div class="line">        forks_attr-&gt;forks[left_fork].philosopher = left_fork;</div>
<div class="line"> </div>
<div class="line">        phil-&gt;saved_doing = PHIL_GIVE_FORK;</div>
<div class="line">    } <span class="keywordflow">else</span> { <span class="comment">/* Claim-based solution */</span></div>
<div class="line">        <span class="comment">/* The forks are simply flagged as available */</span></div>
<div class="line"> </div>
<div class="line">        forks_attr-&gt;forks[right_fork].status = FORK_AVAILABLE;</div>
<div class="line">        forks_attr-&gt;forks[left_fork].status  = FORK_AVAILABLE;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Release the mutex protecting the critical section */</span></div>
<div class="line">    phil-&gt;saved_count = PHIL_ASK_LEFT_FORK;</div>
<div class="line">    <a class="code" href="cthread__api_8h.html#a82f7feccbed077f56e9c05e45d6978a0">cthread_mutex_unlock</a>(forks_attr-&gt;fork_mutex);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*******************************************************************************</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * philosopher_run - A philosopher task&#39;s run routine</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * This routine is the starting point for each of the philosopher task.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * RETURNS: N/A</span></div>
<div class="line"><span class="comment"> * ERRNO: N/A</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * \NOMANUAL</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">philosopher_run(<span class="keywordtype">void</span> *arg)</div>
<div class="line">{</div>
<div class="line">    phil_info_t *phil              = arg;</div>
<div class="line">    <span class="keywordtype">int</span> my_num                     = phil-&gt;idx;         <span class="comment">/* This philosopher&#39;s order number */</span></div>
<div class="line">    <span class="keywordtype">int</span> solution                   = phil-&gt;solution;    <span class="comment">/* Solution to execute */</span></div>
<div class="line">    phil_attr_t *phils_attr        = phil-&gt;philos_attr; <span class="comment">/* Philosophers attributes */</span></div>
<div class="line">    fork_attr_t *forks_attr        = phil-&gt;forks_attr;  <span class="comment">/* Forks attributes*/</span></div>
<div class="line">    stats_t *pStats                = phil-&gt;stats;       <span class="comment">/* statistics data */</span></div>
<div class="line">    <span class="keyword">struct </span>cthread_barrier **b     = &amp;barriers[<a name="a4"></a><a class="code" href="cne_8h.html#a0f9cdd535e00d18a2c8aa9a318ec7bec">cne_id</a>()];</div>
<div class="line">    phils_attr-&gt;i_am_ready[my_num] = <span class="keyword">true</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (<a name="a5"></a><a class="code" href="cthread__api_8h.html#ab0cf67ee5ec1549a043f80522275deac">cthread_set_thread_private</a>(NULL, phil) &lt; 0) {</div>
<div class="line">        <a name="a6"></a><a class="code" href="cne__stdio_8h.html#acb5e6a7e2a06a6e65de91e951186606d">cne_printf</a>(<span class="stringliteral">&quot;Failed to set private data for thread\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <a name="a7"></a><a class="code" href="cthread__api_8h.html#a02c4b4341c351cccc9b17b91e3781dbe">cthread_barrier_wait</a>(*b);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">do</span> {</div>
<div class="line">        phil-&gt;doing = PHIL_THINKING;</div>
<div class="line"> </div>
<div class="line">        phil-&gt;saved_count = 0;</div>
<div class="line">        <a name="a8"></a><a class="code" href="cthread__api_8h.html#afc5169ce197489a97227690ab5f876ee">cthread_sleep_msec</a>(rand() &amp; 0x3FF);</div>
<div class="line"> </div>
<div class="line">        phil-&gt;doing = PHIL_WANTS_TO_EAT;</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * If the forks cannot be acquired this implementation simply does</span></div>
<div class="line"><span class="comment">         * an active wait and checks again for the fork&#39;s availability after a</span></div>
<div class="line"><span class="comment">         * random milli-seconds of delay.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">while</span> (forks_get(phil, my_num, solution, forks_attr) == <span class="keyword">false</span>) {</div>
<div class="line">            <span class="keywordflow">if</span> (solution == TICKET_BASED)</div>
<div class="line">                phil-&gt;doing = PHIL_WAIT_FORK;</div>
<div class="line">            <span class="keywordflow">if</span> (phil-&gt;quit)</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            pStats-&gt;go_hungry[my_num]++;</div>
<div class="line">            phil-&gt;saved_count = 1;</div>
<div class="line">            <a class="code" href="cthread__api_8h.html#afc5169ce197489a97227690ab5f876ee">cthread_sleep_msec</a>(rand() &amp; 0x3FF);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        phil-&gt;doing = PHIL_ASK_RIGHT_FORK;</div>
<div class="line"> </div>
<div class="line">        pStats-&gt;food_in_take[my_num]++;</div>
<div class="line">        phil-&gt;saved_count = 2;</div>
<div class="line">        <a class="code" href="cthread__api_8h.html#afc5169ce197489a97227690ab5f876ee">cthread_sleep_msec</a>(rand() &amp; 0x3FF);</div>
<div class="line"> </div>
<div class="line">        forks_put(phil, my_num, solution, forks_attr);</div>
<div class="line">    } <span class="keywordflow">while</span> (phil-&gt;quit == 0);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*******************************************************************************</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * phil_demo_start - Dining philosopher demo</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * This is the main entry of the dining philosopher&#39;s demo.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * If the demo is left to run forever (the default) then it will stop and</span></div>
<div class="line"><span class="comment"> * print statistics when the main task is resumed from the shell.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * RETURNS: N/A</span></div>
<div class="line"><span class="comment"> * ERRNO: N/A</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line">phil_demo_start(<span class="keywordtype">void</span> *arg)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>app_info *a = arg;</div>
<div class="line">    phil_info_t *phil;</div>
<div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> solution;   <span class="comment">/* Either one of the impl. solutions */</span></div>
<div class="line">    phil_attr_t philos_attr; <span class="comment">/* Philosopher attributes */</span></div>
<div class="line">    fork_attr_t forks_attr;  <span class="comment">/* Fork attributes */</span></div>
<div class="line">    stats_t stats;           <span class="comment">/* Statistic data */</span></div>
<div class="line">    <span class="keywordtype">char</span> name[32];</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* By default let&#39;s run the claim-based solution */</span></div>
<div class="line">    solution = TICKET_BASED;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Default number of philosophers */</span></div>
<div class="line">    philos_attr.num_phil = (a-&gt;num_threads &gt; <a class="code" href="cne_8h.html#a2c459c8e32edf901e224424846b84763">cne_max_threads</a>()) ? <a class="code" href="cne_8h.html#a2c459c8e32edf901e224424846b84763">cne_max_threads</a>()</div>
<div class="line">                                                                : a-&gt;num_threads;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* There is as many forks as there are philosophers */</span></div>
<div class="line">    forks_attr.num_forks = philos_attr.num_phil;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Create the various arrays used in this implementation */</span></div>
<div class="line">    philos_attr.i_am_ready = calloc((<span class="keywordtype">size_t</span>)philos_attr.num_phil, <span class="keyword">sizeof</span>(BOOL));</div>
<div class="line">    stats.food_in_take     = calloc((<span class="keywordtype">size_t</span>)philos_attr.num_phil, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>));</div>
<div class="line">    forks_attr.forks       = calloc((<span class="keywordtype">size_t</span>)philos_attr.num_phil, <span class="keyword">sizeof</span>(fork_t));</div>
<div class="line">    stats.go_hungry        = calloc((<span class="keywordtype">size_t</span>)philos_attr.num_phil, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>));</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (forks_attr.forks) {</div>
<div class="line">        <span class="comment">/* Initialize the owner of the forks */</span></div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; philos_attr.num_phil; i++)</div>
<div class="line">            forks_attr.forks[i].philosopher = -1;</div>
<div class="line">    } <span class="keywordflow">else</span></div>
<div class="line">        <span class="keywordflow">goto</span> err;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Create mutex semaphore protecting the critical sections */</span></div>
<div class="line">    <a name="a9"></a><a class="code" href="cthread__api_8h.html#ae26ec342fec4ad985c13a6e5a0695fa8">cthread_mutex_init</a>(<span class="stringliteral">&quot;phil mutex&quot;</span>, &amp;forks_attr.fork_mutex, NULL);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">int</span> <span class="keywordtype">id</span>                     = <a class="code" href="cne_8h.html#a0f9cdd535e00d18a2c8aa9a318ec7bec">cne_id</a>();</div>
<div class="line">    <span class="keyword">struct </span>cthread_barrier **b = &amp;barriers[id];</div>
<div class="line"> </div>
<div class="line">    snprintf(name, <span class="keyword">sizeof</span>(name), <span class="stringliteral">&quot;Barrier-%d&quot;</span>, <span class="keywordtype">id</span>);</div>
<div class="line">    <a name="a10"></a><a class="code" href="cthread__api_8h.html#a6fbb21865ce86098da5fa57d4a3dee52">cthread_barrier_init</a>(name, b, philos_attr.num_phil + 1);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Create philosopher tasks */</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; philos_attr.num_phil; i++) {</div>
<div class="line">        phil = calloc(1, <span class="keyword">sizeof</span>(phil_info_t));</div>
<div class="line">        <span class="keywordflow">if</span> (!phil)</div>
<div class="line">            <a name="a11"></a><a class="code" href="cne__log_8h.html#ad8375acbd0957d02439e7b8d7f3a6e22">CNE_ERR_GOTO</a>(error, <span class="stringliteral">&quot;Unable to allocate philosopher structure %d\n&quot;</span>, i);</div>
<div class="line">        phil-&gt;doing       = PHIL_THINKING;</div>
<div class="line">        phil-&gt;idx         = i;</div>
<div class="line">        phil-&gt;solution    = solution;</div>
<div class="line">        phil-&gt;philos_attr = &amp;philos_attr;</div>
<div class="line">        phil-&gt;forks_attr  = &amp;forks_attr;</div>
<div class="line">        phil-&gt;stats       = &amp;stats;</div>
<div class="line">        snprintf(name, <span class="keyword">sizeof</span>(name), <span class="stringliteral">&quot;Philospher-%d&quot;</span>, i);</div>
<div class="line">        phil-&gt;cthd = <a name="a12"></a><a class="code" href="cthread__api_8h.html#a86495d8e330a9bd939bdcc5854a4793e">cthread_create</a>(name, philosopher_run, phil);</div>
<div class="line">        <span class="keywordflow">if</span> (!phil-&gt;cthd)</div>
<div class="line">            <a class="code" href="cne__log_8h.html#a1d0beb10fedcde55b30a10c41e565045">CNE_RET</a>(<span class="stringliteral">&quot;Unable to start philosopher cthread %d\n&quot;</span>, i);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="cthread__api_8h.html#a02c4b4341c351cccc9b17b91e3781dbe">cthread_barrier_wait</a>(*b);</div>
<div class="line"> </div>
<div class="line">    <a name="a13"></a><a class="code" href="cthread__api_8h.html#a11f5b8a418bd5c3098701158ddd6544a">cthread_barrier_destroy</a>(*b);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">do</span> {</div>
<div class="line">        <a class="code" href="cthread__api_8h.html#afc5169ce197489a97227690ab5f876ee">cthread_sleep_msec</a>(250);</div>
<div class="line">    } <span class="keywordflow">while</span> (phil_quit == 0);</div>
<div class="line"> </div>
<div class="line">error:</div>
<div class="line">    <span class="comment">/* Free resources */</span></div>
<div class="line">    <a name="a14"></a><a class="code" href="cthread__api_8h.html#a216bebe8cf2555c2b9d8ae19336ff941">cthread_mutex_destroy</a>(forks_attr.fork_mutex);</div>
<div class="line">err:</div>
<div class="line">    free(philos_attr.i_am_ready);</div>
<div class="line">    free(stats.food_in_take);</div>
<div class="line">    free(stats.go_hungry);</div>
<div class="line">    free(forks_attr.forks);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span></div>
<div class="line">phil_demo_quit(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    phil_quit = 1;</div>
<div class="line">}</div>
<div class="ttc" id="acne_8h_html"><div class="ttname"><a href="cne_8h.html">cne.h</a></div></div>
<div class="ttc" id="acne_8h_html_a0f9cdd535e00d18a2c8aa9a318ec7bec"><div class="ttname"><a href="cne_8h.html#a0f9cdd535e00d18a2c8aa9a318ec7bec">cne_id</a></div><div class="ttdeci">CNDP_API int cne_id(void)</div></div>
<div class="ttc" id="acne_8h_html_a2c459c8e32edf901e224424846b84763"><div class="ttname"><a href="cne_8h.html#a2c459c8e32edf901e224424846b84763">cne_max_threads</a></div><div class="ttdeci">CNDP_API int cne_max_threads(void)</div></div>
<div class="ttc" id="acne__branch__prediction_8h_html"><div class="ttname"><a href="cne__branch__prediction_8h.html">cne_branch_prediction.h</a></div></div>
<div class="ttc" id="acne__common_8h_html"><div class="ttname"><a href="cne__common_8h.html">cne_common.h</a></div></div>
<div class="ttc" id="acne__cycles_8h_html"><div class="ttname"><a href="cne__cycles_8h.html">cne_cycles.h</a></div></div>
<div class="ttc" id="acne__log_8h_html"><div class="ttname"><a href="cne__log_8h.html">cne_log.h</a></div></div>
<div class="ttc" id="acne__log_8h_html_a1d0beb10fedcde55b30a10c41e565045"><div class="ttname"><a href="cne__log_8h.html#a1d0beb10fedcde55b30a10c41e565045">CNE_RET</a></div><div class="ttdeci">#define CNE_RET(...)</div><div class="ttdef"><b>Definition:</b> <a href="cne__log_8h_source.html#l00211">cne_log.h:211</a></div></div>
<div class="ttc" id="acne__log_8h_html_ad8375acbd0957d02439e7b8d7f3a6e22"><div class="ttname"><a href="cne__log_8h.html#ad8375acbd0957d02439e7b8d7f3a6e22">CNE_ERR_GOTO</a></div><div class="ttdeci">#define CNE_ERR_GOTO(lbl,...)</div><div class="ttdef"><b>Definition:</b> <a href="cne__log_8h_source.html#l00246">cne_log.h:246</a></div></div>
<div class="ttc" id="acne__per__thread_8h_html"><div class="ttname"><a href="cne__per__thread_8h.html">cne_per_thread.h</a></div></div>
<div class="ttc" id="acne__prefetch_8h_html"><div class="ttname"><a href="cne__prefetch_8h.html">cne_prefetch.h</a></div></div>
<div class="ttc" id="acne__spinlock_8h_html"><div class="ttname"><a href="cne__spinlock_8h.html">cne_spinlock.h</a></div></div>
<div class="ttc" id="acne__stdio_8h_html_acb5e6a7e2a06a6e65de91e951186606d"><div class="ttname"><a href="cne__stdio_8h.html#acb5e6a7e2a06a6e65de91e951186606d">cne_printf</a></div><div class="ttdeci">CNDP_API int cne_printf(const char *fmt,...)</div></div>
<div class="ttc" id="acne__system_8h_html"><div class="ttname"><a href="cne__system_8h.html">cne_system.h</a></div></div>
<div class="ttc" id="acne__tailq_8h_html"><div class="ttname"><a href="cne__tailq_8h.html">cne_tailq.h</a></div></div>
<div class="ttc" id="acne__timer_8h_html"><div class="ttname"><a href="cne__timer_8h.html">cne_timer.h</a></div></div>
<div class="ttc" id="acthread__api_8h_html"><div class="ttname"><a href="cthread__api_8h.html">cthread_api.h</a></div></div>
<div class="ttc" id="acthread__api_8h_html_a02c4b4341c351cccc9b17b91e3781dbe"><div class="ttname"><a href="cthread__api_8h.html#a02c4b4341c351cccc9b17b91e3781dbe">cthread_barrier_wait</a></div><div class="ttdeci">CNDP_API int cthread_barrier_wait(struct cthread_barrier *b)</div></div>
<div class="ttc" id="acthread__api_8h_html_a11f5b8a418bd5c3098701158ddd6544a"><div class="ttname"><a href="cthread__api_8h.html#a11f5b8a418bd5c3098701158ddd6544a">cthread_barrier_destroy</a></div><div class="ttdeci">CNDP_API int cthread_barrier_destroy(struct cthread_barrier *b)</div></div>
<div class="ttc" id="acthread__api_8h_html_a216bebe8cf2555c2b9d8ae19336ff941"><div class="ttname"><a href="cthread__api_8h.html#a216bebe8cf2555c2b9d8ae19336ff941">cthread_mutex_destroy</a></div><div class="ttdeci">CNDP_API int cthread_mutex_destroy(struct cthread_mutex *mutex)</div></div>
<div class="ttc" id="acthread__api_8h_html_a2282be9fe60bd26e3489b0f8f6a890ec"><div class="ttname"><a href="cthread__api_8h.html#a2282be9fe60bd26e3489b0f8f6a890ec">cthread_mutex_lock</a></div><div class="ttdeci">CNDP_API int cthread_mutex_lock(struct cthread_mutex *mutex)</div></div>
<div class="ttc" id="acthread__api_8h_html_a6fbb21865ce86098da5fa57d4a3dee52"><div class="ttname"><a href="cthread__api_8h.html#a6fbb21865ce86098da5fa57d4a3dee52">cthread_barrier_init</a></div><div class="ttdeci">CNDP_API int cthread_barrier_init(const char *name, struct cthread_barrier **barr, unsigned count)</div></div>
<div class="ttc" id="acthread__api_8h_html_a82f7feccbed077f56e9c05e45d6978a0"><div class="ttname"><a href="cthread__api_8h.html#a82f7feccbed077f56e9c05e45d6978a0">cthread_mutex_unlock</a></div><div class="ttdeci">CNDP_API int cthread_mutex_unlock(struct cthread_mutex *mutex)</div></div>
<div class="ttc" id="acthread__api_8h_html_a86495d8e330a9bd939bdcc5854a4793e"><div class="ttname"><a href="cthread__api_8h.html#a86495d8e330a9bd939bdcc5854a4793e">cthread_create</a></div><div class="ttdeci">CNDP_API struct cthread * cthread_create(const char *name, cthread_func_t func, void *arg)</div></div>
<div class="ttc" id="acthread__api_8h_html_ab0cf67ee5ec1549a043f80522275deac"><div class="ttname"><a href="cthread__api_8h.html#ab0cf67ee5ec1549a043f80522275deac">cthread_set_thread_private</a></div><div class="ttdeci">CNDP_API int cthread_set_thread_private(struct cthread *c, void *arg)</div></div>
<div class="ttc" id="acthread__api_8h_html_ae26ec342fec4ad985c13a6e5a0695fa8"><div class="ttname"><a href="cthread__api_8h.html#ae26ec342fec4ad985c13a6e5a0695fa8">cthread_mutex_init</a></div><div class="ttdeci">CNDP_API int cthread_mutex_init(const char *name, struct cthread_mutex **mutex, const struct cthread_mutexattr *attr)</div></div>
<div class="ttc" id="acthread__api_8h_html_afc5169ce197489a97227690ab5f876ee"><div class="ttname"><a href="cthread__api_8h.html#afc5169ce197489a97227690ab5f876ee">cthread_sleep_msec</a></div><div class="ttdeci">CNDP_API void cthread_sleep_msec(uint64_t ms)</div></div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>

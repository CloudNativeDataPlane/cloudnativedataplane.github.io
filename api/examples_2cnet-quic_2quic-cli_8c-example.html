<!-- HTML header for doxygen 1.9.1-->
<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<!--<meta charset="utf-8">-->
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CNDP: examples/cnet-quic/quic-cli.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="/assets/css/styles.css" rel="stylesheet" type="text/css" />
<link href="/assets/css/custom_doxygen.css" rel="stylesheet" type="text/css" />
<link href="/assets/images/favicon.png" rel="icon" type="image/x-icon">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
</head>
<body>
<nav class="navbar navbar-expand-md navbar-dark bg-blue px-2">
  <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <a class="navbar-brand" href="/" aria-label="CNDP">
    <img src="/assets/images/CNDP_logo_tiny.png" alt="CNDP">
  </a>
  <div class="collapse navbar-collapse" id="navbarSupportedContent">
    <div class="navbar-nav mr-auto">
      <a class="nav-link header-link" href="/blog/">Blog</a>
      <a class="nav-link header-link" href="/community/">Community</a>
      <a class="nav-link header-link" href="/dev/">Development</a>
      <a class="nav-link header-link" href="/doc/">Documentation</a>
    </div>
    <div class="navbar-nav ms-auto me-3">
      <a class="nav-link header-link" href="https://github.com/CloudNativeDataPlane/cndp">
        <svg xmlns="http://www.w3.org/2000/svg" class="navbar-nav-svg"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
      </a>
    </div>
  </div>
</nav>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">CNDP
   &#160;<span id="projectnumber">22.08.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('examples_2cnet-quic_2quic-cli_8c-example.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">examples/cnet-quic/quic-cli.c</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Copyright (c) 2017 Fastly, Kazuho Oku</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Permission is hereby granted, free of charge, to any person obtaining a copy</span></div>
<div class="line"><span class="comment"> * of this software and associated documentation files (the &quot;Software&quot;), to</span></div>
<div class="line"><span class="comment"> * deal in the Software without restriction, including without limitation the</span></div>
<div class="line"><span class="comment"> * rights to use, copy, modify, merge, publish, distribute, sublicense, and/or</span></div>
<div class="line"><span class="comment"> * sell copies of the Software, and to permit persons to whom the Software is</span></div>
<div class="line"><span class="comment"> * furnished to do so, subject to the following conditions:</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * The above copyright notice and this permission notice shall be included in</span></div>
<div class="line"><span class="comment"> * all copies or substantial portions of the Software.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span></div>
<div class="line"><span class="comment"> * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span></div>
<div class="line"><span class="comment"> * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span></div>
<div class="line"><span class="comment"> * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span></div>
<div class="line"><span class="comment"> * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING</span></div>
<div class="line"><span class="comment"> * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS</span></div>
<div class="line"><span class="comment"> * IN THE SOFTWARE.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/select.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/socket.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/stat.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/time.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sys/types.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;getopt.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;netinet/udp.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;fcntl.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;netdb.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;bsd/bsd.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;picotls.h&gt;</span></div>
<div class="line"><span class="preprocessor">#if QUICLY_HAVE_FUSION</span></div>
<div class="line"><span class="preprocessor">#include &quot;picotls/fusion.h&quot;</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor">#include &quot;quicly.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;quicly/defaults.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;quicly/streambuf.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;../deps/picotls/t/util.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cnet_8h.html">cnet.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cnet__chnl_8h.html">cnet_chnl.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cnet__chnl__opt_8h.html">cnet_chnl_opt.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cnet__netlink_8h.html">cnet_netlink.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cnet__netif_8h.html">cnet_netif.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="cnet__meta_8h.html">cnet_meta.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="hexdump_8h.html">hexdump.h</a>&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;cnet-quic.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define MAX_BURST_PACKETS 10</span></div>
<div class="line"> </div>
<div class="line">FILE *quicly_trace_fp      = NULL;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">unsigned</span> verbosity  = 0;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> suppress_output = 0, send_datagram_frame = 0;</div>
<div class="line"><span class="keyword">static</span> int64_t enqueue_requests_at = 0, request_interval = 0;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> is_server;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> save_session_ticket_cb(ptls_save_ticket_t *_self, ptls_t *tls, ptls_iovec_t src);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> on_client_hello_cb(ptls_on_client_hello_t *_self, ptls_t *tls,</div>
<div class="line">                              ptls_on_client_hello_parameters_t *params);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *session_file = NULL;</div>
<div class="line"><span class="keyword">static</span> ptls_handshake_properties_t hs_properties;</div>
<div class="line"><span class="keyword">static</span> quicly_transport_parameters_t resumed_transport_params;</div>
<div class="line"><span class="keyword">static</span> ptls_iovec_t resumption_token;</div>
<div class="line"><span class="keyword">static</span> quicly_context_t ctx;</div>
<div class="line"><span class="keyword">static</span> quicly_cid_plaintext_t next_cid;</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>{</div>
<div class="line">    ptls_aead_context_t *enc, *dec;</div>
<div class="line">} address_token_aead;</div>
<div class="line"><span class="keyword">static</span> ptls_save_ticket_t save_session_ticket = {save_session_ticket_cb};</div>
<div class="line"><span class="keyword">static</span> ptls_on_client_hello_t on_client_hello = {on_client_hello_cb};</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> enforce_retry;</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if QUICLY_HAVE_FUSION</span></div>
<div class="line"><span class="comment">// clang-format off</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> ptls_cipher_suite_t fusion_aes128gcmsha256 = {</div>
<div class="line">    PTLS_CIPHER_SUITE_AES_128_GCM_SHA256,</div>
<div class="line">    &amp;ptls_fusion_aes128gcm,</div>
<div class="line">    &amp;ptls_openssl_sha256</div>
<div class="line">    },</div>
<div class="line">    fusion_aes256gcmsha384 = {</div>
<div class="line">        PTLS_CIPHER_SUITE_AES_256_GCM_SHA384,</div>
<div class="line">        &amp;ptls_fusion_aes256gcm,</div>
<div class="line">        &amp;ptls_openssl_sha384</div>
<div class="line">    };</div>
<div class="line"><span class="comment">// clang-format on</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> ptls_key_exchange_algorithm_t *key_exchanges[128];</div>
<div class="line"><span class="keyword">static</span> ptls_cipher_suite_t *cipher_suites[128];</div>
<div class="line"><span class="comment">// clang-format off</span></div>
<div class="line"><span class="keyword">static</span> ptls_context_t tlsctx = {</div>
<div class="line">    .random_bytes       = ptls_openssl_random_bytes,</div>
<div class="line">    .get_time           = &amp;ptls_get_time,</div>
<div class="line">    .key_exchanges      = key_exchanges,</div>
<div class="line">    .cipher_suites      = cipher_suites,</div>
<div class="line">    .require_dhe_on_psk = 1,</div>
<div class="line">    .save_ticket        = &amp;save_session_ticket,</div>
<div class="line">    .on_client_hello    = &amp;on_client_hello</div>
<div class="line">};</div>
<div class="line"><span class="comment">// clang-format on</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>{</div>
<div class="line">    ptls_iovec_t list[16];</div>
<div class="line">    <span class="keywordtype">size_t</span> count;</div>
<div class="line">} negotiated_protocols;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>{</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *path;</div>
<div class="line">    <span class="keywordtype">int</span> to_file;</div>
<div class="line">} * reqs;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>st_stream_data_t {</div>
<div class="line">    quicly_streambuf_t streambuf;</div>
<div class="line">    FILE *outfp;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> on_stop_sending(quicly_stream_t *stream, <span class="keywordtype">int</span> err);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> on_receive_reset(quicly_stream_t *stream, <span class="keywordtype">int</span> err);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> server_on_receive(quicly_stream_t *stream, <span class="keywordtype">size_t</span> off, <span class="keyword">const</span> <span class="keywordtype">void</span> *src, <span class="keywordtype">size_t</span> len);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> client_on_receive(quicly_stream_t *stream, <span class="keywordtype">size_t</span> off, <span class="keyword">const</span> <span class="keywordtype">void</span> *src, <span class="keywordtype">size_t</span> len);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// clang-format off</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> quicly_stream_callbacks_t server_stream_callbacks = {</div>
<div class="line">    quicly_streambuf_destroy,</div>
<div class="line">    quicly_streambuf_egress_shift,</div>
<div class="line">    quicly_streambuf_egress_emit,</div>
<div class="line">    on_stop_sending,</div>
<div class="line">    server_on_receive,</div>
<div class="line">    on_receive_reset</div>
<div class="line">    },</div>
<div class="line">    client_stream_callbacks = {</div>
<div class="line">        quicly_streambuf_destroy,</div>
<div class="line">        quicly_streambuf_egress_shift,</div>
<div class="line">        quicly_streambuf_egress_emit,</div>
<div class="line">        on_stop_sending,</div>
<div class="line">        client_on_receive,</div>
<div class="line">        on_receive_reset</div>
<div class="line">    };</div>
<div class="line"><span class="comment">// clang-format on</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">dump_stats(FILE *fp, quicly_conn_t *conn)</div>
<div class="line">{</div>
<div class="line">    quicly_stats_t stats;</div>
<div class="line"> </div>
<div class="line">    quicly_get_stats(conn, &amp;stats);</div>
<div class="line">    fprintf(fp,</div>
<div class="line">            <span class="stringliteral">&quot;packets-received: %&quot;</span> PRIu64 <span class="stringliteral">&quot;, packets-decryption-failed: %&quot;</span> PRIu64</div>
<div class="line">            <span class="stringliteral">&quot;, packets-sent: %&quot;</span> PRIu64 <span class="stringliteral">&quot;, packets-lost: %&quot;</span> PRIu64 <span class="stringliteral">&quot;, ack-received: %&quot;</span> PRIu64</div>
<div class="line">            <span class="stringliteral">&quot;, late-acked: %&quot;</span> PRIu64 <span class="stringliteral">&quot;, bytes-received: %&quot;</span> PRIu64 <span class="stringliteral">&quot;, bytes-sent: %&quot;</span> PRIu64</div>
<div class="line">            <span class="stringliteral">&quot;, srtt: %&quot;</span> PRIu32 <span class="stringliteral">&quot;\n&quot;</span>,</div>
<div class="line">            stats.num_packets.received, stats.num_packets.decryption_failed, stats.num_packets.sent,</div>
<div class="line">            stats.num_packets.lost, stats.num_packets.ack_received, stats.num_packets.late_acked,</div>
<div class="line">            stats.num_bytes.received, stats.num_bytes.sent, stats.rtt.smoothed);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">validate_path(<span class="keyword">const</span> <span class="keywordtype">char</span> *path)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (path[0] != <span class="charliteral">&#39;/&#39;</span>)</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* TODO avoid false positives on the client-side */</span></div>
<div class="line">    <span class="keywordflow">if</span> (strstr(path, <span class="stringliteral">&quot;/.&quot;</span>) != NULL)</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 1;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">parse_request(ptls_iovec_t input, <span class="keywordtype">char</span> **path, <span class="keywordtype">int</span> *is_http1)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">size_t</span> off = 0, path_start;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (off = 0; off != input.len; ++off)</div>
<div class="line">        <span class="keywordflow">if</span> (input.base[off] == <span class="charliteral">&#39; &#39;</span>)</div>
<div class="line">            <span class="keywordflow">goto</span> EndOfMethod;</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line"> </div>
<div class="line">EndOfMethod:</div>
<div class="line">    ++off;</div>
<div class="line">    path_start = off;</div>
<div class="line">    <span class="keywordflow">for</span> (; off != input.len; ++off)</div>
<div class="line">        <span class="keywordflow">if</span> (input.base[off] == <span class="charliteral">&#39; &#39;</span> || input.base[off] == <span class="charliteral">&#39;\r&#39;</span> || input.base[off] == <span class="charliteral">&#39;\n&#39;</span>)</div>
<div class="line">            <span class="keywordflow">goto</span> EndOfPath;</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line"> </div>
<div class="line">EndOfPath:</div>
<div class="line">    *path           = (<span class="keywordtype">char</span> *)(input.base + path_start);</div>
<div class="line">    *is_http1       = input.base[off] == <span class="charliteral">&#39; &#39;</span>;</div>
<div class="line">    input.base[off] = <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line">    <span class="keywordflow">return</span> 1;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">send_str(quicly_stream_t *stream, <span class="keyword">const</span> <span class="keywordtype">char</span> *s)</div>
<div class="line">{</div>
<div class="line">    quicly_streambuf_egress_write(stream, s, strlen(s));</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">send_header(quicly_stream_t *stream, <span class="keywordtype">int</span> is_http1, <span class="keywordtype">int</span> status, <span class="keyword">const</span> <span class="keywordtype">char</span> *mime_type)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> buf[256];</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (!is_http1)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">    sprintf(buf, <span class="stringliteral">&quot;HTTP/1.1 %03d OK\r\nConnection: close\r\nContent-Type: %s\r\n\r\n&quot;</span>, status,</div>
<div class="line">            mime_type);</div>
<div class="line">    send_str(stream, buf);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">flatten_file_vec(quicly_sendbuf_vec_t *vec, <span class="keywordtype">void</span> *dst, <span class="keywordtype">size_t</span> off, <span class="keywordtype">size_t</span> len)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> fd = (intptr_t)vec-&gt;cbdata;</div>
<div class="line">    ssize_t rret;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* FIXME handle partial read */</span></div>
<div class="line">    while ((rret = pread(fd, dst, len, off)) == -1 &amp;&amp; errno == EINTR)</div>
<div class="line">        ;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> rret == len</div>
<div class="line">               ? 0</div>
<div class="line">               : QUICLY_TRANSPORT_ERROR_INTERNAL; <span class="comment">/* should return application-level error */</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">discard_file_vec(quicly_sendbuf_vec_t *vec)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> fd = (intptr_t)vec-&gt;cbdata;</div>
<div class="line">    close(fd);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">send_file(quicly_stream_t *stream, <span class="keywordtype">int</span> is_http1, <span class="keyword">const</span> <span class="keywordtype">char</span> *fn, <span class="keyword">const</span> <span class="keywordtype">char</span> *mime_type)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> quicly_streambuf_sendvec_callbacks_t send_file_callbacks = {flatten_file_vec,</div>
<div class="line">                                                                             discard_file_vec};</div>
<div class="line">    <span class="keywordtype">int</span> fd;</div>
<div class="line">    <span class="keyword">struct </span>stat st;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> ((fd = open(fn, O_RDONLY)) == -1)</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (fstat(fd, &amp;st) != 0 || S_ISDIR(st.st_mode)) {</div>
<div class="line">        close(fd);</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    send_header(stream, is_http1, 200, mime_type);</div>
<div class="line">    quicly_sendbuf_vec_t vec = {&amp;send_file_callbacks, (size_t)st.st_size, (<span class="keywordtype">void</span> *)(intptr_t)fd};</div>
<div class="line">    quicly_streambuf_egress_write_vec(stream, &amp;vec);</div>
<div class="line">    <span class="keywordflow">return</span> 1;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">flatten_sized_text(quicly_sendbuf_vec_t *vec, <span class="keywordtype">void</span> *dst, <span class="keywordtype">size_t</span> off, <span class="keywordtype">size_t</span> len)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> pattern[] =</div>
<div class="line">        <span class="stringliteral">&quot;hello world\nhello world\nhello world\nhello world\nhello world\nhello world\nhello &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;world\nhello world\nhello &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;world\nhello world\nhello world\nhello world\nhello world\nhello world\nhello &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;world\nhello world\nhello world\nhello &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;world\nhello world\nhello world\nhello world\nhello world\nhello world\nhello &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;world\nhello world\nhello world\nhello &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;world\nhello world\nhello world\nhello world\nhello world\nhello world\nhello &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;world\nhello world\nhello world\nhello &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;world\nhello world\nhello world\nhello world\nhello world\nhello world\nhello &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;world\nhello world\nhello world\nhello &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;world\nhello world\nhello world\nhello world\nhello world\nhello world\nhello &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;world\nhello world\nhello world\nhello &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;world\nhello world\nhello world\nhello world\nhello world\nhello world\nhello &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;world\nhello world\nhello world\nhello &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;world\nhello world\nhello world\nhello world\nhello world\nhello world\nhello &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;world\nhello world\nhello world\nhello &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;world\nhello world\nhello world\nhello world\nhello world\nhello world\nhello &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;world\nhello world\nhello world\nhello &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;world\nhello world\nhello world\nhello world\nhello world\nhello world\nhello &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;world\nhello world\nhello world\nhello &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;world\nhello world\nhello world\nhello world\nhello world\nhello world\nhello &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;world\nhello world\nhello world\nhello &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;world\nhello world\nhello world\nhello world\nhello world\nhello world\nhello &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;world\nhello world\nhello world\nhello &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;world\nhello world\nhello world\nhello world\nhello world\nhello world\nhello &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;world\nhello world\nhello world\nhello &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;world\nhello world\nhello world\nhello world\nhello world\nhello world\nhello &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;world\nhello world\nhello world\nhello &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;world\nhello world\nhello world\nhello world\nhello world\nhello world\nhello &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;world\nhello world\nhello world\nhello &quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;world\nhello world\nhello world\nhello world\nhello world\nhello world\n&quot;</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">while</span> (len != 0) {</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">char</span> *src = pattern + off % 12;</div>
<div class="line">        <span class="keywordflow">if</span> (src + len - pattern &lt;= <span class="keyword">sizeof</span>(pattern) - 1) {</div>
<div class="line">            memcpy(dst, src, len);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">        memcpy(dst, src, <span class="keyword">sizeof</span>(pattern) - 20);</div>
<div class="line">        off += <span class="keyword">sizeof</span>(pattern) - 20;</div>
<div class="line">        dst = (<span class="keywordtype">char</span> *)dst + (<span class="keyword">sizeof</span>(pattern) - 20);</div>
<div class="line">        len -= <span class="keyword">sizeof</span>(pattern) - 20;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#undef PATTERN</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">send_sized_text(quicly_stream_t *stream, <span class="keyword">const</span> <span class="keywordtype">char</span> *path, <span class="keywordtype">int</span> is_http1)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">size_t</span> size;</div>
<div class="line">    <span class="keywordtype">int</span> lastpos;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (sscanf(path, <span class="stringliteral">&quot;/%zu%n&quot;</span>, &amp;size, &amp;lastpos) != 1)</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (lastpos != strlen(path))</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line"> </div>
<div class="line">    send_header(stream, is_http1, 200, <span class="stringliteral">&quot;text/plain; charset=utf-8&quot;</span>);</div>
<div class="line">    <span class="keyword">static</span> <span class="keyword">const</span> quicly_streambuf_sendvec_callbacks_t callbacks = {flatten_sized_text};</div>
<div class="line">    quicly_sendbuf_vec_t vec                                    = {&amp;callbacks, size, NULL};</div>
<div class="line">    quicly_streambuf_egress_write_vec(stream, &amp;vec);</div>
<div class="line">    <span class="keywordflow">return</span> 1;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">on_stop_sending(quicly_stream_t *stream, <span class="keywordtype">int</span> err)</div>
<div class="line">{</div>
<div class="line">    assert(QUICLY_ERROR_IS_QUIC_APPLICATION(err));</div>
<div class="line">    fprintf(stderr, <span class="stringliteral">&quot;received STOP_SENDING: %&quot;</span> PRIu16 <span class="stringliteral">&quot;\n&quot;</span>, QUICLY_ERROR_GET_ERROR_CODE(err));</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">on_receive_reset(quicly_stream_t *stream, <span class="keywordtype">int</span> err)</div>
<div class="line">{</div>
<div class="line">    assert(QUICLY_ERROR_IS_QUIC_APPLICATION(err));</div>
<div class="line">    fprintf(stderr, <span class="stringliteral">&quot;received RESET_STREAM: %&quot;</span> PRIu16 <span class="stringliteral">&quot;\n&quot;</span>, QUICLY_ERROR_GET_ERROR_CODE(err));</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">server_on_receive(quicly_stream_t *stream, <span class="keywordtype">size_t</span> off, <span class="keyword">const</span> <span class="keywordtype">void</span> *src, <span class="keywordtype">size_t</span> len)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> *path;</div>
<div class="line">    <span class="keywordtype">int</span> is_http1;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (!quicly_sendstate_is_open(&amp;stream-&gt;sendstate))</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (quicly_streambuf_ingress_receive(stream, off, src, len) != 0)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (!parse_request(quicly_streambuf_ingress_get(stream), &amp;path, &amp;is_http1)) {</div>
<div class="line">        <span class="keywordflow">if</span> (!quicly_recvstate_transfer_complete(&amp;stream-&gt;recvstate))</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        <span class="comment">/* failed to parse request */</span></div>
<div class="line">        send_header(stream, 1, 500, <span class="stringliteral">&quot;text/plain; charset=utf-8&quot;</span>);</div>
<div class="line">        send_str(stream, <span class="stringliteral">&quot;failed to parse HTTP request\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">goto</span> Sent;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (!quicly_recvstate_transfer_complete(&amp;stream-&gt;recvstate))</div>
<div class="line">        quicly_request_stop(stream, QUICLY_ERROR_FROM_APPLICATION_ERROR_CODE(0));</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (strcmp(path, <span class="stringliteral">&quot;/logo.jpg&quot;</span>) == 0 &amp;&amp;</div>
<div class="line">        send_file(stream, is_http1, <span class="stringliteral">&quot;examples/cnet-quic/assets/logo.jpg&quot;</span>, <span class="stringliteral">&quot;image/jpeg&quot;</span>))</div>
<div class="line">        <span class="keywordflow">goto</span> Sent;</div>
<div class="line">    <span class="keywordflow">if</span> (strcmp(path, <span class="stringliteral">&quot;/main.jpg&quot;</span>) == 0 &amp;&amp;</div>
<div class="line">        send_file(stream, is_http1, <span class="stringliteral">&quot;examples/cnet-quic/assets/main.jpg&quot;</span>, <span class="stringliteral">&quot;image/jpeg&quot;</span>))</div>
<div class="line">        <span class="keywordflow">goto</span> Sent;</div>
<div class="line">    <span class="keywordflow">if</span> (strcmp(path, <span class="stringliteral">&quot;/jnk.tar&quot;</span>) == 0 &amp;&amp;</div>
<div class="line">        send_file(stream, is_http1, <span class="stringliteral">&quot;examples/cnet-quic/assets/jnk.tar&quot;</span>, <span class="stringliteral">&quot;image/jpeg&quot;</span>))</div>
<div class="line">        <span class="keywordflow">goto</span> Sent;</div>
<div class="line">    <span class="keywordflow">if</span> (send_sized_text(stream, path, is_http1))</div>
<div class="line">        <span class="keywordflow">goto</span> Sent;</div>
<div class="line">    <span class="keywordflow">if</span> (validate_path(path) &amp;&amp; send_file(stream, is_http1, path + 1, <span class="stringliteral">&quot;text/plain&quot;</span>))</div>
<div class="line">        <span class="keywordflow">goto</span> Sent;</div>
<div class="line"> </div>
<div class="line">    send_header(stream, is_http1, 404, <span class="stringliteral">&quot;text/plain; charset=utf-8&quot;</span>);</div>
<div class="line">    send_str(stream, <span class="stringliteral">&quot;not found\n&quot;</span>);</div>
<div class="line">Sent:</div>
<div class="line">    quicly_streambuf_egress_shutdown(stream);</div>
<div class="line">    quicly_streambuf_ingress_shift(stream, len);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">client_on_receive(quicly_stream_t *stream, <span class="keywordtype">size_t</span> off, <span class="keyword">const</span> <span class="keywordtype">void</span> *src, <span class="keywordtype">size_t</span> len)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>st_stream_data_t *stream_data = stream-&gt;data;</div>
<div class="line">    ptls_iovec_t input;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (quicly_streambuf_ingress_receive(stream, off, src, len) != 0)</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> ((input = quicly_streambuf_ingress_get(stream)).len != 0) {</div>
<div class="line">        <span class="keywordflow">if</span> (!suppress_output) {</div>
<div class="line">            FILE *out = (stream_data-&gt;outfp == NULL) ? stdout : stream_data-&gt;outfp;</div>
<div class="line">            fwrite(input.base, 1, input.len, out);</div>
<div class="line">            fflush(out);</div>
<div class="line">        }</div>
<div class="line">        quicly_streambuf_ingress_shift(stream, input.len);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (quicly_recvstate_transfer_complete(&amp;stream-&gt;recvstate)) {</div>
<div class="line">        <span class="keywordflow">if</span> (stream_data-&gt;outfp != NULL)</div>
<div class="line">            fclose(stream_data-&gt;outfp);</div>
<div class="line">        <span class="keyword">static</span> <span class="keywordtype">size_t</span> num_resp_received;</div>
<div class="line">        ++num_resp_received;</div>
<div class="line">        <span class="keywordflow">if</span> (reqs[num_resp_received].path == NULL) {</div>
<div class="line">            <span class="keywordflow">if</span> (request_interval != 0)</div>
<div class="line">                enqueue_requests_at = ctx.now-&gt;cb(ctx.now) + request_interval;</div>
<div class="line">            <span class="keywordflow">else</span> {</div>
<div class="line">                dump_stats(stderr, stream-&gt;conn);</div>
<div class="line">                quicly_close(stream-&gt;conn, 0, <span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">on_stream_open(quicly_stream_open_t *<span class="keyword">self</span>, quicly_stream_t *stream)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> ((ret = quicly_streambuf_create(stream, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> st_stream_data_t))) != 0)</div>
<div class="line">        <span class="keywordflow">return</span> ret;</div>
<div class="line"> </div>
<div class="line">    stream-&gt;callbacks = ctx.tls-&gt;certificates.count != 0 ? &amp;server_stream_callbacks</div>
<div class="line">                                                         : &amp;client_stream_callbacks;</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> quicly_stream_open_t stream_open = {&amp;on_stream_open};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">on_closed_by_remote(quicly_closed_by_remote_t *<span class="keyword">self</span>, quicly_conn_t *conn, <span class="keywordtype">int</span> err,</div>
<div class="line">                    uint64_t frame_type, <span class="keyword">const</span> <span class="keywordtype">char</span> *reason, <span class="keywordtype">size_t</span> reason_len)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (QUICLY_ERROR_IS_QUIC_TRANSPORT(err))</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;transport close:code=0x%&quot;</span> PRIx16 <span class="stringliteral">&quot;;frame=%&quot;</span> PRIu64 <span class="stringliteral">&quot;;reason=%.*s\n&quot;</span>,</div>
<div class="line">                QUICLY_ERROR_GET_ERROR_CODE(err), frame_type, (<span class="keywordtype">int</span>)reason_len, reason);</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (QUICLY_ERROR_IS_QUIC_APPLICATION(err))</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;application close:code=0x%&quot;</span> PRIx16 <span class="stringliteral">&quot;;reason=%.*s\n&quot;</span>,</div>
<div class="line">                QUICLY_ERROR_GET_ERROR_CODE(err), (<span class="keywordtype">int</span>)reason_len, reason);</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err == QUICLY_ERROR_RECEIVED_STATELESS_RESET)</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;stateless reset\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err == QUICLY_ERROR_NO_COMPATIBLE_VERSION)</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;no compatible version\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;unexpected close:code=%d\n&quot;</span>, err);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> quicly_closed_by_remote_t closed_by_remote = {&amp;on_closed_by_remote};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">on_generate_resumption_token(quicly_generate_resumption_token_t *<span class="keyword">self</span>, quicly_conn_t *conn,</div>
<div class="line">                             ptls_buffer_t *buf, quicly_address_token_plaintext_t *token)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> quicly_encrypt_address_token(tlsctx.random_bytes, address_token_aead.enc, buf, buf-&gt;off,</div>
<div class="line">                                        token);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> quicly_generate_resumption_token_t generate_resumption_token = {</div>
<div class="line">    &amp;on_generate_resumption_token};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">send_packets_default(<span class="keywordtype">int</span> cd, <span class="keyword">struct</span> sockaddr *dest, <span class="keyword">struct</span> iovec *packets, <span class="keywordtype">size_t</span> num_packets)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i != num_packets; ++i) {</div>
<div class="line">        <a name="_a0"></a><a class="code" href="structpktmbuf__s.html">pktmbuf_t</a> *m;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (verbosity &gt;= 2)</div>
<div class="line">            <a name="a1"></a><a class="code" href="hexdump_8h.html#ad43b85b23d613f2633e4c2daaa2762b1">cne_hexdump</a>(NULL, <span class="stringliteral">&quot;sendmsg&quot;</span>, packets[i].iov_base, packets[i].iov_len);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (<a name="a2"></a><a class="code" href="pktdev__api_8h.html#a3b4e99e57c23cbe92863182322cb1d6b">pktdev_buf_alloc</a>(0, &amp;m, 1) == 0)</div>
<div class="line">            <a name="a3"></a><a class="code" href="cne__log_8h.html#a1d0beb10fedcde55b30a10c41e565045">CNE_RET</a>(<span class="stringliteral">&quot;Unable to allocate mbufs\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (<a name="a4"></a><a class="code" href="pktmbuf_8h.html#aa531e514fe3bd73404257ed569170e5b">pktmbuf_write</a>(packets[i].iov_base, packets[i].iov_len, m, 0) == NULL)</div>
<div class="line">            <a class="code" href="cne__log_8h.html#a1d0beb10fedcde55b30a10c41e565045">CNE_RET</a>(<span class="stringliteral">&quot;Unable to copy data into mbuf\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (<a name="a5"></a><a class="code" href="cnet__chnl_8h.html#aa8eb33f9b15b4992e170214ca214fe33">chnl_sendto</a>(cd, dest, &amp;m, 1) &lt; 0)</div>
<div class="line">            perror(<span class="stringliteral">&quot;sendmsg failed&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef x__linux__</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifndef UDP_SEGMENT</span></div>
<div class="line"><span class="preprocessor">#define UDP_SEGMENT 103</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">send_packets_gso(<span class="keyword">struct</span> chnl *ch, <span class="keyword">struct</span> sockaddr *dest, <span class="keyword">struct</span> iovec *packets, <span class="keywordtype">size_t</span> num_packets)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// clang-format off</span></div>
<div class="line">    <span class="keyword">struct </span>iovec vec   = {</div>
<div class="line">        .iov_base = (<span class="keywordtype">void</span> *)packets[0].iov_base,</div>
<div class="line">        .iov_len  = (<span class="keywordtype">char</span> *)packets[num_packets - 1].iov_base +</div>
<div class="line">                    packets[num_packets - 1].iov_len - (<span class="keywordtype">char</span> *)packets[0].iov_base</div>
<div class="line">    };</div>
<div class="line">    <span class="comment">// clang-format on</span></div>
<div class="line">    <span class="keyword">struct </span>msghdr mess = {</div>
<div class="line">        .msg_name    = dest,</div>
<div class="line">        .msg_namelen = quicly_get_socklen(dest),</div>
<div class="line">        .msg_iov     = &amp;vec,</div>
<div class="line">        .msg_iovlen  = 1,</div>
<div class="line">    };</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">union </span>{</div>
<div class="line">        <span class="keyword">struct </span>cmsghdr hdr;</div>
<div class="line">        <span class="keywordtype">char</span> buf[CMSG_SPACE(<span class="keyword">sizeof</span>(uint16_t))];</div>
<div class="line">    } cmsg;</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (num_packets != 1) {</div>
<div class="line">        cmsg.hdr.cmsg_level               = SOL_UDP;</div>
<div class="line">        cmsg.hdr.cmsg_type                = UDP_SEGMENT;</div>
<div class="line">        cmsg.hdr.cmsg_len                 = CMSG_LEN(<span class="keyword">sizeof</span>(uint16_t));</div>
<div class="line">        *(uint16_t *)CMSG_DATA(&amp;cmsg.hdr) = packets[0].iov_len;</div>
<div class="line">        mess.msg_control                  = &amp;cmsg;</div>
<div class="line">        mess.msg_controllen               = (socklen_t)CMSG_SPACE(<span class="keyword">sizeof</span>(uint16_t));</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">while</span> ((ret = chnl_sendmsg(ch, &amp;mess, &amp;mbuf, 1)) == -1 &amp;&amp; errno == EINTR)</div>
<div class="line">        ;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (ret == -1)</div>
<div class="line">        perror(<span class="stringliteral">&quot;sendmsg failed&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> void (*send_packets)(<span class="keywordtype">int</span> cd, <span class="keyword">struct </span>sockaddr *, <span class="keyword">struct </span>iovec *,</div>
<div class="line">                            size_t) = send_packets_default;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">send_one_packet(<span class="keywordtype">int</span> cd, <span class="keyword">struct</span> sockaddr *dest, <span class="keyword">const</span> <span class="keywordtype">void</span> *payload, <span class="keywordtype">size_t</span> payload_len)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>iovec vec = {.iov_base = (<span class="keywordtype">void</span> *)payload, .iov_len = payload_len};</div>
<div class="line">    send_packets(cd, dest, &amp;vec, 1);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">send_pending(<span class="keywordtype">int</span> cd, quicly_conn_t *conn)</div>
<div class="line">{</div>
<div class="line">    quicly_address_t dest, src;</div>
<div class="line">    <span class="keyword">struct </span>iovec packets[MAX_BURST_PACKETS];</div>
<div class="line">    uint8_t</div>
<div class="line">        buf[MAX_BURST_PACKETS * quicly_get_context(conn)-&gt;transport_params.max_udp_payload_size];</div>
<div class="line">    <span class="keywordtype">size_t</span> num_packets = MAX_BURST_PACKETS;</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> ((ret = quicly_send(conn, &amp;dest, &amp;src, packets, &amp;num_packets, buf, <span class="keyword">sizeof</span>(buf))) == 0 &amp;&amp;</div>
<div class="line">        num_packets != 0)</div>
<div class="line">        send_packets(cd, &amp;dest.sa, packets, num_packets);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> ret;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">on_receive_datagram_frame(quicly_receive_datagram_frame_t *<span class="keyword">self</span>, quicly_conn_t *conn,</div>
<div class="line">                          ptls_iovec_t payload)</div>
<div class="line">{</div>
<div class="line">    printf(<span class="stringliteral">&quot;DATAGRAM: %.*s\n&quot;</span>, (<span class="keywordtype">int</span>)payload.len, payload.base);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* send responds with a datagram frame */</span></div>
<div class="line">    <span class="keywordflow">if</span> (!quicly_is_client(conn))</div>
<div class="line">        quicly_send_datagram_frames(conn, &amp;payload, 1);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">enqueue_requests(quicly_conn_t *conn)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; reqs[i].path != NULL; ++i) {</div>
<div class="line">        <span class="keywordtype">char</span> req[1024], destfile[1024];</div>
<div class="line">        quicly_stream_t *stream;</div>
<div class="line">        <span class="keywordtype">int</span> ret;</div>
<div class="line"> </div>
<div class="line">        ret = quicly_open_stream(conn, &amp;stream, 0);</div>
<div class="line">        assert(ret == 0);</div>
<div class="line">        sprintf(req, <span class="stringliteral">&quot;GET %s\r\n&quot;</span>, reqs[i].path);</div>
<div class="line">        send_str(stream, req);</div>
<div class="line">        quicly_streambuf_egress_shutdown(stream);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (reqs[i].to_file &amp;&amp; !suppress_output) {</div>
<div class="line">            <span class="keyword">struct </span>st_stream_data_t *stream_data = stream-&gt;data;</div>
<div class="line"> </div>
<div class="line">            sprintf(destfile, <span class="stringliteral">&quot;%s.downloaded&quot;</span>, strrchr(reqs[i].path, <span class="charliteral">&#39;/&#39;</span>) + 1);</div>
<div class="line">            stream_data-&gt;outfp = fopen(destfile, <span class="stringliteral">&quot;w&quot;</span>);</div>
<div class="line">            <span class="keywordflow">if</span> (stream_data-&gt;outfp == NULL) {</div>
<div class="line">                fprintf(stderr, <span class="stringliteral">&quot;failed to open destination file:%s:%s\n&quot;</span>, reqs[i].path,</div>
<div class="line">                        strerror(errno));</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    enqueue_requests_at = INT64_MAX;</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">run_client(<span class="keywordtype">int</span> cd, <a class="code" href="structpktmbuf__s.html">pktmbuf_t</a> *mbuf)</div>
<div class="line">{</div>
<div class="line">    quicly_conn_t *conn = NULL;</div>
<div class="line"> </div>
<div class="line">    uint8_t buf[ctx.transport_params.max_udp_payload_size];</div>
<div class="line">    <span class="keyword">struct </span>sockaddr sa;</div>
<div class="line">    ssize_t rret = <a name="a6"></a><a class="code" href="pktmbuf_8h.html#a034b66bc273e1340547cb7288685ad2f">pktmbuf_data_len</a>(mbuf);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (verbosity &gt;= 2)</div>
<div class="line">        <a class="code" href="hexdump_8h.html#ad43b85b23d613f2633e4c2daaa2762b1">cne_hexdump</a>(NULL, <span class="stringliteral">&quot;recvmsg&quot;</span>, <a name="a7"></a><a class="code" href="pktmbuf_8h.html#a77fa2b918e3052b564b228868d58c198">pktmbuf_mtod</a>(mbuf, <span class="keywordtype">char</span> *), rret);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">size_t</span> off = 0;</div>
<div class="line">    <span class="keywordflow">while</span> (off != rret) {</div>
<div class="line">        quicly_decoded_packet_t packet;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (quicly_decode_packet(&amp;ctx, &amp;packet, buf, rret, &amp;off) == SIZE_MAX)</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">        quicly_receive(conn, NULL, &amp;sa, &amp;packet);</div>
<div class="line">        <span class="keywordflow">if</span> (send_datagram_frame &amp;&amp; quicly_connection_is_ready(conn)) {</div>
<div class="line">            <span class="keyword">const</span> <span class="keywordtype">char</span> *message   = <span class="stringliteral">&quot;hello datagram!&quot;</span>;</div>
<div class="line">            ptls_iovec_t datagram = ptls_iovec_init(message, strlen(message));</div>
<div class="line"> </div>
<div class="line">            quicly_send_datagram_frames(conn, &amp;datagram, 1);</div>
<div class="line">            send_datagram_frame = 0;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (conn != NULL) {</div>
<div class="line">        <span class="keywordtype">int</span> ret = send_pending(cd, conn);</div>
<div class="line">        <span class="keywordflow">if</span> (ret != 0) {</div>
<div class="line">            quicly_free(conn);</div>
<div class="line">            conn = NULL;</div>
<div class="line">            <span class="keywordflow">if</span> (ret == QUICLY_ERROR_FREE_CONNECTION)</div>
<div class="line">                <span class="keywordflow">return</span> 0;</div>
<div class="line">            <span class="keywordflow">else</span> {</div>
<div class="line">                fprintf(stderr, <span class="stringliteral">&quot;quicly_send returned %d\n&quot;</span>, ret);</div>
<div class="line">                <span class="keywordflow">return</span> 1;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> quicly_conn_t **conns;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">size_t</span> num_conns = 0;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">validate_token(<span class="keyword">struct</span> sockaddr *remote, ptls_iovec_t client_cid, ptls_iovec_t server_cid,</div>
<div class="line">               quicly_address_token_plaintext_t *token, <span class="keyword">const</span> <span class="keywordtype">char</span> **err_desc)</div>
<div class="line">{</div>
<div class="line">    int64_t age;</div>
<div class="line">    <span class="keywordtype">int</span> port_is_equal;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* calculate and normalize age */</span></div>
<div class="line">    <span class="keywordflow">if</span> ((age = ctx.now-&gt;cb(ctx.now) - token-&gt;issued_at) &lt; 0)</div>
<div class="line">        age = 0;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* check address, deferring the use of port number match to type-specific checks */</span></div>
<div class="line">    <span class="keywordflow">if</span> (remote-&gt;sa_family != token-&gt;remote.sa.sa_family)</div>
<div class="line">        <span class="keywordflow">goto</span> AddressMismatch;</div>
<div class="line">    <span class="keywordflow">switch</span> (remote-&gt;sa_family) {</div>
<div class="line">    <span class="keywordflow">case</span> AF_INET: {</div>
<div class="line">        <span class="keyword">struct </span>sockaddr_in *sin = (<span class="keyword">struct </span>sockaddr_in *)remote;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (sin-&gt;sin_addr.s_addr != token-&gt;remote.sin.sin_addr.s_addr)</div>
<div class="line">            <span class="keywordflow">goto</span> AddressMismatch;</div>
<div class="line">        port_is_equal = sin-&gt;sin_port == token-&gt;remote.sin.sin_port;</div>
<div class="line">    } <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> AF_INET6: {</div>
<div class="line">        <span class="keyword">struct </span>sockaddr_in6 *sin6 = (<span class="keyword">struct </span>sockaddr_in6 *)remote;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (memcmp(&amp;sin6-&gt;sin6_addr, &amp;token-&gt;remote.sin6.sin6_addr, <span class="keyword">sizeof</span>(sin6-&gt;sin6_addr)) != 0)</div>
<div class="line">            <span class="keywordflow">goto</span> AddressMismatch;</div>
<div class="line">        port_is_equal = sin6-&gt;sin6_port == token-&gt;remote.sin6.sin6_port;</div>
<div class="line">    } <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">default</span>:</div>
<div class="line">        <span class="keywordflow">goto</span> UnknownAddressType;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* type-specific checks */</span></div>
<div class="line">    <span class="keywordflow">switch</span> (token-&gt;type) {</div>
<div class="line">    <span class="keywordflow">case</span> QUICLY_ADDRESS_TOKEN_TYPE_RETRY:</div>
<div class="line">        <span class="keywordflow">if</span> (age &gt; 30000)</div>
<div class="line">            <span class="keywordflow">goto</span> Expired;</div>
<div class="line">        <span class="keywordflow">if</span> (!port_is_equal)</div>
<div class="line">            <span class="keywordflow">goto</span> AddressMismatch;</div>
<div class="line">        <span class="keywordflow">if</span> (!quicly_cid_is_equal(&amp;token-&gt;retry.client_cid, client_cid))</div>
<div class="line">            <span class="keywordflow">goto</span> CIDMismatch;</div>
<div class="line">        <span class="keywordflow">if</span> (!quicly_cid_is_equal(&amp;token-&gt;retry.server_cid, server_cid))</div>
<div class="line">            <span class="keywordflow">goto</span> CIDMismatch;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> QUICLY_ADDRESS_TOKEN_TYPE_RESUMPTION:</div>
<div class="line">        <span class="keywordflow">if</span> (age &gt; 10 * 60 * 1000)</div>
<div class="line">            <span class="keywordflow">goto</span> Expired;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">default</span>:</div>
<div class="line">        assert(!<span class="stringliteral">&quot;unexpected token type&quot;</span>);</div>
<div class="line">        abort();</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* success */</span></div>
<div class="line">    *err_desc = NULL;</div>
<div class="line">    <span class="keywordflow">return</span> 1;</div>
<div class="line"> </div>
<div class="line">AddressMismatch:</div>
<div class="line">    *err_desc = <span class="stringliteral">&quot;token address mismatch&quot;</span>;</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">UnknownAddressType:</div>
<div class="line">    *err_desc = <span class="stringliteral">&quot;unknown address type&quot;</span>;</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">Expired:</div>
<div class="line">    *err_desc = <span class="stringliteral">&quot;token expired&quot;</span>;</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">CIDMismatch:</div>
<div class="line">    *err_desc = <span class="stringliteral">&quot;CID mismatch&quot;</span>;</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">run_server(<span class="keywordtype">int</span> cd, <a class="code" href="structpktmbuf__s.html">pktmbuf_t</a> *mbuf)</div>
<div class="line">{</div>
<div class="line">    uint8_t *buf = <a class="code" href="pktmbuf_8h.html#a77fa2b918e3052b564b228868d58c198">pktmbuf_mtod</a>(mbuf, uint8_t *);</div>
<div class="line">    quicly_address_t remote;</div>
<div class="line">    <span class="keywordtype">size_t</span> len               = <a class="code" href="pktmbuf_8h.html#a034b66bc273e1340547cb7288685ad2f">pktmbuf_data_len</a>(mbuf);</div>
<div class="line">    <span class="keyword">struct </span>cnet_metadata *md = <a name="a8"></a><a class="code" href="pktmbuf_8h.html#a4c8ba493b2f1752a05f261df112925e4">pktmbuf_metadata</a>(mbuf);</div>
<div class="line">    <span class="keyword">struct </span>sockaddr_in *sa   = (<span class="keyword">struct </span>sockaddr_in *)&amp;remote.sa;</div>
<div class="line"> </div>
<div class="line">    sa-&gt;sin_family      = AF_INET;</div>
<div class="line">    sa-&gt;sin_port        = md-&gt;faddr.cin_port;</div>
<div class="line">    sa-&gt;sin_addr.s_addr = md-&gt;faddr.cin_addr.s_addr;</div>
<div class="line"> </div>
<div class="line">    if (verbosity &gt;= 2)</div>
<div class="line">        <a class="code" href="hexdump_8h.html#ad43b85b23d613f2633e4c2daaa2762b1">cne_hexdump</a>(NULL, <span class="stringliteral">&quot;recvmsg&quot;</span>, buf, len);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">size_t</span> off = 0;</div>
<div class="line">    <span class="keywordflow">while</span> (off != len) {</div>
<div class="line">        quicly_decoded_packet_t packet;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (quicly_decode_packet(&amp;ctx, &amp;packet, buf, len, &amp;off) == SIZE_MAX)</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (QUICLY_PACKET_IS_LONG_HEADER(packet.octets.base[0])) {</div>
<div class="line">            <span class="keywordflow">if</span> (packet.version != 0 &amp;&amp; !quicly_is_supported_version(packet.version)) {</div>
<div class="line">                uint8_t payload[ctx.transport_params.max_udp_payload_size];</div>
<div class="line">                <span class="keywordtype">size_t</span> payload_len =</div>
<div class="line">                    quicly_send_version_negotiation(&amp;ctx, packet.cid.src, packet.cid.dest.encrypted,</div>
<div class="line">                                                    quicly_supported_versions, payload);</div>
<div class="line"> </div>
<div class="line">                assert(payload_len != SIZE_MAX);</div>
<div class="line">                send_one_packet(cd, &amp;remote.sa, payload, payload_len);</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            <span class="comment">/* there is no way to send response to these v1 packets */</span></div>
<div class="line">            <span class="keywordflow">if</span> (packet.cid.dest.encrypted.len &gt; QUICLY_MAX_CID_LEN_V1 ||</div>
<div class="line">                packet.cid.src.len &gt; QUICLY_MAX_CID_LEN_V1)</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        quicly_conn_t *conn = NULL;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i != num_conns; ++i) {</div>
<div class="line">            <span class="keywordflow">if</span> (quicly_is_destination(conns[i], NULL, &amp;remote.sa, &amp;packet)) {</div>
<div class="line">                conn = conns[i];</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (conn != NULL)</div>
<div class="line">            quicly_receive(conn, NULL, &amp;remote.sa, &amp;packet); <span class="comment">/* existing connection */</span></div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (QUICLY_PACKET_IS_INITIAL(packet.octets.base[0])) {</div>
<div class="line">            <span class="comment">/* long header packet; potentially a new connection */</span></div>
<div class="line">            quicly_address_token_plaintext_t *token = NULL, token_buf;</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (packet.token.len != 0) {</div>
<div class="line">                <span class="keyword">const</span> <span class="keywordtype">char</span> *err_desc = NULL;</div>
<div class="line">                <span class="keywordtype">int</span> ret =</div>
<div class="line">                    quicly_decrypt_address_token(address_token_aead.dec, &amp;token_buf,</div>
<div class="line">                                                 packet.token.base, packet.token.len, 0, &amp;err_desc);</div>
<div class="line">                <span class="keywordflow">if</span> (ret == 0 &amp;&amp; validate_token(&amp;remote.sa, packet.cid.src,</div>
<div class="line">                                               packet.cid.dest.encrypted, &amp;token_buf, &amp;err_desc)) {</div>
<div class="line">                    token = &amp;token_buf;</div>
<div class="line">                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (enforce_retry &amp;&amp;</div>
<div class="line">                           (ret == QUICLY_TRANSPORT_ERROR_INVALID_TOKEN ||</div>
<div class="line">                            (ret == 0 &amp;&amp; token_buf.type == QUICLY_ADDRESS_TOKEN_TYPE_RETRY))) {</div>
<div class="line">                    <span class="comment">/* Token that looks like retry was unusable, and we require retry.</span></div>
<div class="line"><span class="comment">                     * There&#39;s no chance of the handshake succeeding. Therefore, send</span></div>
<div class="line"><span class="comment">                     * close without acquiring state. */</span></div>
<div class="line">                    uint8_t payload[ctx.transport_params.max_udp_payload_size];</div>
<div class="line">                    <span class="keywordtype">size_t</span> payload_len = quicly_send_close_invalid_token(</div>
<div class="line">                        &amp;ctx, packet.version, packet.cid.src, packet.cid.dest.encrypted, err_desc,</div>
<div class="line">                        payload);</div>
<div class="line">                    assert(payload_len != SIZE_MAX);</div>
<div class="line">                    send_one_packet(cd, &amp;remote.sa, payload, payload_len);</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">if</span> (enforce_retry &amp;&amp; token == NULL &amp;&amp; packet.cid.dest.encrypted.len &gt;= 8) {</div>
<div class="line">                <span class="comment">/* unbound connection; send a retry token unless the client has supplied</span></div>
<div class="line"><span class="comment">                 * the correct one, but not too many</span></div>
<div class="line"><span class="comment">                 */</span></div>
<div class="line">                uint8_t new_server_cid[8], payload[ctx.transport_params.max_udp_payload_size];</div>
<div class="line">                memcpy(new_server_cid, packet.cid.dest.encrypted.base, <span class="keyword">sizeof</span>(new_server_cid));</div>
<div class="line">                new_server_cid[0] ^= 0xff;</div>
<div class="line">                <span class="keywordtype">size_t</span> payload_len = quicly_send_retry(</div>
<div class="line">                    &amp;ctx, address_token_aead.enc, packet.version, &amp;remote.sa, packet.cid.src, NULL,</div>
<div class="line">                    ptls_iovec_init(new_server_cid, <span class="keyword">sizeof</span>(new_server_cid)),</div>
<div class="line">                    packet.cid.dest.encrypted, ptls_iovec_init(NULL, 0), ptls_iovec_init(NULL, 0),</div>
<div class="line">                    NULL, payload);</div>
<div class="line">                assert(payload_len != SIZE_MAX);</div>
<div class="line">                send_one_packet(cd, &amp;remote.sa, payload, payload_len);</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                <span class="comment">/* new connection */</span></div>
<div class="line">                <span class="keywordtype">int</span> ret =</div>
<div class="line">                    quicly_accept(&amp;conn, &amp;ctx, NULL, &amp;remote.sa, &amp;packet, token, &amp;next_cid, NULL);</div>
<div class="line">                <span class="keywordflow">if</span> (ret == 0) {</div>
<div class="line">                    assert(conn != NULL);</div>
<div class="line">                    ++next_cid.master_id;</div>
<div class="line">                    conns = realloc(conns, <span class="keyword">sizeof</span>(*conns) * (num_conns + 1));</div>
<div class="line">                    assert(conns != NULL);</div>
<div class="line">                    conns[num_conns++] = conn;</div>
<div class="line">                } <span class="keywordflow">else</span></div>
<div class="line">                    assert(conn == NULL);</div>
<div class="line">            }</div>
<div class="line">        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!QUICLY_PACKET_IS_LONG_HEADER(packet.octets.base[0])) {</div>
<div class="line">            <span class="comment">/* short header packet; potentially a dead connection. No need to check the</span></div>
<div class="line"><span class="comment">             * length of the incoming packet, because loop is prevented by</span></div>
<div class="line"><span class="comment">             * authenticating the CID (by checking node_id and thread_id). If the peer</span></div>
<div class="line"><span class="comment">             * is</span></div>
<div class="line"><span class="comment">             * also sending a reset, then the next CID is highly likely to contain a</span></div>
<div class="line"><span class="comment">             * non-authenticating CID, ... */</span></div>
<div class="line">            <span class="keywordflow">if</span> (packet.cid.dest.plaintext.node_id == 0 &amp;&amp;</div>
<div class="line">                packet.cid.dest.plaintext.thread_id == 0) {</div>
<div class="line">                uint8_t payload[ctx.transport_params.max_udp_payload_size];</div>
<div class="line">                <span class="keywordtype">size_t</span> payload_len =</div>
<div class="line">                    quicly_send_stateless_reset(&amp;ctx, packet.cid.dest.encrypted.base, payload);</div>
<div class="line">                assert(payload_len != SIZE_MAX);</div>
<div class="line">                send_one_packet(cd, &amp;remote.sa, payload, payload_len);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i != num_conns; ++i) {</div>
<div class="line">        <span class="keywordflow">if</span> (quicly_get_first_timeout(conns[i]) &lt;= ctx.now-&gt;cb(ctx.now)) {</div>
<div class="line">            <span class="keywordflow">if</span> (send_pending(cd, conns[i]) != 0) {</div>
<div class="line">                dump_stats(stderr, conns[i]);</div>
<div class="line">                quicly_free(conns[i]);</div>
<div class="line">                memmove(conns + i, conns + i + 1, (num_conns - i - 1) * <span class="keyword">sizeof</span>(*conns));</div>
<div class="line">                --i;</div>
<div class="line">                --num_conns;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">load_session(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">static</span> uint8_t buf[65536];</div>
<div class="line">    <span class="keywordtype">size_t</span> len;</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">        FILE *fp;</div>
<div class="line">        <span class="keywordflow">if</span> ((fp = fopen(session_file, <span class="stringliteral">&quot;rb&quot;</span>)) == NULL)</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        len = fread(buf, 1, <span class="keyword">sizeof</span>(buf), fp);</div>
<div class="line">        <span class="keywordflow">if</span> (len == 0 || !feof(fp)) {</div>
<div class="line">            fprintf(stderr, <span class="stringliteral">&quot;failed to load ticket from file:%s\n&quot;</span>, session_file);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line">        fclose(fp);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">const</span> uint8_t *src = buf, *end = buf + len;</div>
<div class="line">        ptls_iovec_t ticket;</div>
<div class="line">        ptls_decode_open_block(src, end, 2, {</div>
<div class="line">            <span class="keywordflow">if</span> ((resumption_token.len = end - src) != 0) {</div>
<div class="line">                resumption_token.base = calloc(1, resumption_token.len);</div>
<div class="line">                memcpy(resumption_token.base, src, resumption_token.len);</div>
<div class="line">            }</div>
<div class="line">            src = end;</div>
<div class="line">        });</div>
<div class="line">        ptls_decode_open_block(src, end, 2, {</div>
<div class="line">            ticket = ptls_iovec_init(src, end - src);</div>
<div class="line">            src    = end;</div>
<div class="line">        });</div>
<div class="line">        ptls_decode_open_block(src, end, 2, {</div>
<div class="line">            <span class="keywordflow">if</span> ((ret = quicly_decode_transport_parameter_list(&amp;resumed_transport_params, NULL, NULL,</div>
<div class="line">                                                              NULL, NULL, src, end)) != 0)</div>
<div class="line">                <span class="keywordflow">goto</span> Exit;</div>
<div class="line">            src = end;</div>
<div class="line">        });</div>
<div class="line">        hs_properties.client.session_ticket = ticket;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">Exit:</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>{</div>
<div class="line">    ptls_iovec_t tls_ticket;</div>
<div class="line">    ptls_iovec_t address_token;</div>
<div class="line">} session_info;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">save_session(<span class="keyword">const</span> quicly_transport_parameters_t *transport_params)</div>
<div class="line">{</div>
<div class="line">    ptls_buffer_t buf;</div>
<div class="line">    FILE *fp = NULL;</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (session_file == NULL)</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line"> </div>
<div class="line">    ptls_buffer_init(&amp;buf, <span class="stringliteral">&quot;&quot;</span>, 0);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* build data (session ticket and transport parameters) */</span></div>
<div class="line">    ptls_buffer_push_block(&amp;buf, 2, {</div>
<div class="line">        ptls_buffer_pushv(&amp;buf, session_info.address_token.base, session_info.address_token.len);</div>
<div class="line">    });</div>
<div class="line">    ptls_buffer_push_block(&amp;buf, 2, {</div>
<div class="line">        ptls_buffer_pushv(&amp;buf, session_info.tls_ticket.base, session_info.tls_ticket.len);</div>
<div class="line">    });</div>
<div class="line">    ptls_buffer_push_block(&amp;buf, 2, {</div>
<div class="line">        <span class="keywordflow">if</span> ((ret = quicly_encode_transport_parameter_list(&amp;buf, transport_params, NULL, NULL, NULL,</div>
<div class="line">                                                          NULL, 0)) != 0)</div>
<div class="line">            <span class="keywordflow">goto</span> Exit;</div>
<div class="line">    });</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* write file */</span></div>
<div class="line">    <span class="keywordflow">if</span> ((fp = fopen(session_file, <span class="stringliteral">&quot;wb&quot;</span>)) == NULL) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;failed to open file:%s:%s\n&quot;</span>, session_file, strerror(errno));</div>
<div class="line">        ret = PTLS_ERROR_LIBRARY;</div>
<div class="line">        <span class="keywordflow">goto</span> Exit;</div>
<div class="line">    }</div>
<div class="line">    fwrite(buf.base, 1, buf.off, fp);</div>
<div class="line"> </div>
<div class="line">    ret = 0;</div>
<div class="line">Exit:</div>
<div class="line">    <span class="keywordflow">if</span> (fp != NULL)</div>
<div class="line">        fclose(fp);</div>
<div class="line">    ptls_buffer_dispose(&amp;buf);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">save_session_ticket_cb(ptls_save_ticket_t *_self, ptls_t *tls, ptls_iovec_t src)</div>
<div class="line">{</div>
<div class="line">    free(session_info.tls_ticket.base);</div>
<div class="line">    session_info.tls_ticket = ptls_iovec_init(calloc(1, src.len), src.len);</div>
<div class="line">    memcpy(session_info.tls_ticket.base, src.base, src.len);</div>
<div class="line"> </div>
<div class="line">    quicly_conn_t *conn = *ptls_get_data_ptr(tls);</div>
<div class="line">    <span class="keywordflow">return</span> save_session(quicly_get_remote_transport_parameters(conn));</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">save_resumption_token_cb(quicly_save_resumption_token_t *_self, quicly_conn_t *conn,</div>
<div class="line">                         ptls_iovec_t token)</div>
<div class="line">{</div>
<div class="line">    free(session_info.address_token.base);</div>
<div class="line">    session_info.address_token = ptls_iovec_init(calloc(1, token.len), token.len);</div>
<div class="line">    memcpy(session_info.address_token.base, token.base, token.len);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> save_session(quicly_get_remote_transport_parameters(conn));</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> quicly_save_resumption_token_t save_resumption_token = {save_resumption_token_cb};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span></div>
<div class="line">on_client_hello_cb(ptls_on_client_hello_t *_self, ptls_t *tls,</div>
<div class="line">                   ptls_on_client_hello_parameters_t *params)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> ret;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (negotiated_protocols.count != 0) {</div>
<div class="line">        <span class="keywordtype">size_t</span> i, j;</div>
<div class="line">        <span class="keyword">const</span> ptls_iovec_t *x, *y;</div>
<div class="line">        <span class="keywordflow">for</span> (i = 0; i != negotiated_protocols.count; ++i) {</div>
<div class="line">            x = negotiated_protocols.list + i;</div>
<div class="line">            <span class="keywordflow">for</span> (j = 0; j != params-&gt;negotiated_protocols.count; ++j) {</div>
<div class="line">                y = params-&gt;negotiated_protocols.list + j;</div>
<div class="line">                <span class="keywordflow">if</span> (x-&gt;len == y-&gt;len &amp;&amp; memcmp(x-&gt;base, y-&gt;base, x-&gt;len) == 0)</div>
<div class="line">                    <span class="keywordflow">goto</span> ALPN_Found;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">return</span> PTLS_ALERT_NO_APPLICATION_PROTOCOL;</div>
<div class="line">    ALPN_Found:</div>
<div class="line">        <span class="keywordflow">if</span> ((ret = ptls_set_negotiated_protocol(tls, (<span class="keyword">const</span> <span class="keywordtype">char</span> *)x-&gt;base, x-&gt;len)) != 0)</div>
<div class="line">            <span class="keywordflow">return</span> ret;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">usage(<span class="keyword">const</span> <span class="keywordtype">char</span> *cmd)</div>
<div class="line">{</div>
<div class="line">    printf(<span class="stringliteral">&quot;Usage: %s [options] host port\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;Options:\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;  -a &lt;alpn&gt;                 ALPN identifier; repeat the option to set multiple\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;                            candidates\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;  -b &lt;buffer-size&gt;          specifies the size of the send / receive buffer in\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;                            bytes\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;  -B &lt;cid-key&gt;              CID encryption key (server-only). Randomly generated\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;                            if omitted.\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;  -c certificate-file\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;  -k key-file               specifies the credentials to be used for running the\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;                            server. If omitted, the command runs as a client.\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;  -C &lt;algorithm&gt;            the congestion control algorithm; either \&quot;reno\&quot;\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;                            (default), \&quot;cubic\&quot;, or \&quot;pico\&quot;\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;  -d draft-number           specifies the draft version number to be used (e.g.,\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;                            29)\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;  -e event-log-file         file to log events\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;  -E                        expand Client Hello (sends multiple client Initials)\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;  -G                        enable UDP generic segmentation offload\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;  -i interval               interval to reissue requests (in milliseconds)\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;  -I timeout                idle timeout (in milliseconds; default: 600,000)\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;  -K num-packets            perform key update every num-packets packets\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;  -l log-file               file to log traffic secrets\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;  -M &lt;bytes&gt;                max stream data (in bytes; default: 1MB)\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;  -m &lt;bytes&gt;                max data (in bytes; default: 16MB)\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;  -N                        enforce HelloRetryRequest (client-only)\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;  -n                        enforce version negotiation (client-only)\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;  -O                        suppress output\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;  -p path                   path to request (can be set multiple times)\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;  -P path                   path to request, store response to file (can be set\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;                            multiple times)\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;  -R                        require Retry (server only)\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;  -r [initial-pto]          initial PTO (in milliseconds)\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;  -S [num-speculative-ptos] number of speculative PTOs\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;  -s session-file           file to load / store the session ticket\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;  -u size                   initial size of UDP datagram payload\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;  -U size                   maximum size of UDP datagarm payload\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;  -V                        verify peer using the default certificates\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;  -v                        verbose mode (-vv emits packet dumps as well)\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;  -w packets                initial congestion window (default: 10)\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;  -W public-key-file        use raw public keys (RFC 7250). When set and running\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;                            as a client, the argument specifies the public keys\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;                            that the server is expected to use. When running as\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;                            a server, the argument is ignored.\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;  -x named-group            named group to be used (default: secp256r1)\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;  -X                        max bidirectional stream count (default: 100)\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;  -y cipher-suite           cipher-suite to be used (default: all)\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;  -h                        print this help\n&quot;</span></div>
<div class="line">           <span class="stringliteral">&quot;\n&quot;</span>,</div>
<div class="line">           cmd);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span></div>
<div class="line">push_req(<span class="keyword">const</span> <span class="keywordtype">char</span> *path, <span class="keywordtype">int</span> to_file)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">size_t</span> i;</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; reqs[i].path != NULL; ++i)</div>
<div class="line">        ;</div>
<div class="line">    reqs            = realloc(reqs, <span class="keyword">sizeof</span>(*reqs) * (i + 2));</div>
<div class="line">    reqs[i].path    = path;</div>
<div class="line">    reqs[i].to_file = to_file;</div>
<div class="line">    memset(reqs + i + 1, 0, <span class="keyword">sizeof</span>(*reqs));</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">quic_callback(<span class="keywordtype">int</span> ctype <a name="a9"></a><a class="code" href="cne__common_8h.html#a110ce74779a3879ca9ba9167c968cf27">__cne_unused</a>, <span class="keywordtype">int</span> cd)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="structpktmbuf__s.html">pktmbuf_t</a> *mbufs[128];</div>
<div class="line">    <span class="keywordtype">int</span> nb_mbufs;</div>
<div class="line"> </div>
<div class="line">    nb_mbufs = <a name="a10"></a><a class="code" href="cnet__chnl_8h.html#a22022a742413830c3d48d3ffb1474ca9">chnl_recv</a>(cd, mbufs, 128);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (nb_mbufs &gt; 0) {</div>
<div class="line">        CNE_DEBUG(<span class="stringliteral">&quot;Received %d packets\n&quot;</span>, nb_mbufs);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nb_mbufs; i++)</div>
<div class="line">            <span class="keywordflow">if</span> ((is_server) ? run_server(cd, mbufs[i]) : run_client(cd, mbufs[i]) &lt; 0)</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">        <a name="a11"></a><a class="code" href="pktmbuf_8h.html#aa27ef3ac37cc4956e9722415637f1cfe">pktmbuf_free_bulk</a>(mbufs, nb_mbufs);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">quicly_main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *cert_file = NULL, *raw_pubkey_file = NULL, *host, *port, *cid_key = NULL;</div>
<div class="line">    <span class="keywordtype">unsigned</span> udpbufsize = 0;</div>
<div class="line">    <span class="comment">// clang-format off</span></div>
<div class="line">    <span class="keyword">struct </span>option lgopts[] = {</div>
<div class="line">        {NULL, 0, 0, 0}</div>
<div class="line">    };</div>
<div class="line">    <span class="comment">// clang-format on</span></div>
<div class="line">    <span class="keywordtype">char</span> **argvopt;</div>
<div class="line">    <span class="keywordtype">int</span> opt, option_index;</div>
<div class="line"> </div>
<div class="line">    reqs = calloc(1, <span class="keyword">sizeof</span>(*reqs));</div>
<div class="line"> </div>
<div class="line">    ctx                           = quicly_spec_context;</div>
<div class="line">    ctx.tls                       = &amp;tlsctx;</div>
<div class="line">    ctx.stream_open               = &amp;stream_open;</div>
<div class="line">    ctx.closed_by_remote          = &amp;closed_by_remote;</div>
<div class="line">    ctx.save_resumption_token     = &amp;save_resumption_token;</div>
<div class="line">    ctx.generate_resumption_token = &amp;generate_resumption_token;</div>
<div class="line"> </div>
<div class="line">    setup_session_cache(ctx.tls);</div>
<div class="line">    quicly_amend_ptls_context(ctx.tls);</div>
<div class="line"> </div>
<div class="line">    {</div>
<div class="line">        uint8_t secret[PTLS_MAX_DIGEST_SIZE];</div>
<div class="line"> </div>
<div class="line">        ctx.tls-&gt;random_bytes(secret, ptls_openssl_sha256.digest_size);</div>
<div class="line">        address_token_aead.enc =</div>
<div class="line">            ptls_aead_new(&amp;ptls_openssl_aes128gcm, &amp;ptls_openssl_sha256, 1, secret, <span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line">        address_token_aead.dec =</div>
<div class="line">            ptls_aead_new(&amp;ptls_openssl_aes128gcm, &amp;ptls_openssl_sha256, 0, secret, <span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Reset the value to the initial state. */</span></div>
<div class="line">    argvopt = argv;</div>
<div class="line">    optind  = 1;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">while</span> ((opt = getopt_long(argc, argvopt,</div>
<div class="line">                              <span class="stringliteral">&quot;a:b:B:c:C:Dd:k:Ee:Gi:I:K:l:M:m:NnOp:P:Rr:S:s:u:U:Vvw:W:x:X:y:h&quot;</span>,</div>
<div class="line">                              lgopts, &amp;option_index)) != -1) {</div>
<div class="line">        <span class="keywordflow">switch</span> (opt) {</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;a&#39;</span>:</div>
<div class="line">            assert(negotiated_protocols.count &lt; PTLS_ELEMENTSOF(negotiated_protocols.list));</div>
<div class="line">            negotiated_protocols.list[negotiated_protocols.count++] =</div>
<div class="line">                ptls_iovec_init(optarg, strlen(optarg));</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;b&#39;</span>:</div>
<div class="line">            <span class="keywordflow">if</span> (sscanf(optarg, <span class="stringliteral">&quot;%u&quot;</span>, &amp;udpbufsize) != 1) {</div>
<div class="line">                fprintf(stderr, <span class="stringliteral">&quot;failed to parse buffer size: %s\n&quot;</span>, optarg);</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;B&#39;</span>:</div>
<div class="line">            cid_key = optarg;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;c&#39;</span>:</div>
<div class="line">            cert_file = optarg;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;C&#39;</span>: {</div>
<div class="line">            quicly_cc_type_t **cc;</div>
<div class="line">            <span class="keywordflow">for</span> (cc = quicly_cc_all_types; *cc != NULL; ++cc)</div>
<div class="line">                <span class="keywordflow">if</span> (strcmp((*cc)-&gt;name, optarg) == 0)</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">if</span> (*cc != NULL) {</div>
<div class="line">                ctx.init_cc = (*cc)-&gt;cc_init;</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                fprintf(stderr, <span class="stringliteral">&quot;unknown congestion controller: %s\n&quot;</span>, optarg);</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">            }</div>
<div class="line">        } <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;G&#39;</span>:</div>
<div class="line"><span class="preprocessor">#ifdef x__linux__</span></div>
<div class="line">            send_packets = send_packets_gso;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">            fprintf(stderr, <span class="stringliteral">&quot;UDP GSO only supported on linux\n&quot;</span>);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;k&#39;</span>:</div>
<div class="line">            load_private_key(ctx.tls, optarg);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;d&#39;</span>: {</div>
<div class="line">            uint8_t draft_ver;</div>
<div class="line">            <span class="keywordflow">if</span> (sscanf(optarg, <span class="stringliteral">&quot;%&quot;</span> SCNu8, &amp;draft_ver) != 1) {</div>
<div class="line">                fprintf(stderr, <span class="stringliteral">&quot;failed to parse draft number: %s\n&quot;</span>, optarg);</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">            }</div>
<div class="line">            ctx.initial_version = 0xff000000 | draft_ver;</div>
<div class="line">        } <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;D&#39;</span>:</div>
<div class="line">            send_datagram_frame = 1;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;E&#39;</span>:</div>
<div class="line">            ctx.expand_client_hello = 1;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;e&#39;</span>:</div>
<div class="line">            <span class="keywordflow">if</span> ((quicly_trace_fp = fopen(optarg, <span class="stringliteral">&quot;w&quot;</span>)) == NULL) {</div>
<div class="line">                fprintf(stderr, <span class="stringliteral">&quot;failed to open file:%s:%s\n&quot;</span>, optarg, strerror(errno));</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">            }</div>
<div class="line">            setvbuf(quicly_trace_fp, NULL, _IONBF, 0);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;i&#39;</span>:</div>
<div class="line">            <span class="keywordflow">if</span> (sscanf(optarg, <span class="stringliteral">&quot;%&quot;</span> SCNd64, &amp;request_interval) != 1) {</div>
<div class="line">                fprintf(stderr, <span class="stringliteral">&quot;failed to parse request interval: %s\n&quot;</span>, optarg);</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;I&#39;</span>:</div>
<div class="line">            <span class="keywordflow">if</span> (sscanf(optarg, <span class="stringliteral">&quot;%&quot;</span> SCNd64, &amp;ctx.transport_params.max_idle_timeout) != 1) {</div>
<div class="line">                fprintf(stderr, <span class="stringliteral">&quot;failed to parse idle timeout: %s\n&quot;</span>, optarg);</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;K&#39;</span>:</div>
<div class="line">            <span class="keywordflow">if</span> (sscanf(optarg, <span class="stringliteral">&quot;%&quot;</span> SCNu64, &amp;ctx.max_packets_per_key) != 1) {</div>
<div class="line">                fprintf(stderr, <span class="stringliteral">&quot;failed to parse key update interval: %s\n&quot;</span>, optarg);</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;l&#39;</span>:</div>
<div class="line">            setup_log_event(ctx.tls, optarg);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;M&#39;</span>: {</div>
<div class="line">            uint64_t v;</div>
<div class="line">            <span class="keywordflow">if</span> (sscanf(optarg, <span class="stringliteral">&quot;%&quot;</span> SCNu64, &amp;v) != 1) {</div>
<div class="line">                fprintf(stderr, <span class="stringliteral">&quot;failed to parse max stream data:%s\n&quot;</span>, optarg);</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">            }</div>
<div class="line">            ctx.transport_params.max_stream_data.bidi_local  = v;</div>
<div class="line">            ctx.transport_params.max_stream_data.bidi_remote = v;</div>
<div class="line">            ctx.transport_params.max_stream_data.uni         = v;</div>
<div class="line">        } <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;m&#39;</span>:</div>
<div class="line">            <span class="keywordflow">if</span> (sscanf(optarg, <span class="stringliteral">&quot;%&quot;</span> SCNu64, &amp;ctx.transport_params.max_data) != 1) {</div>
<div class="line">                fprintf(stderr, <span class="stringliteral">&quot;failed to parse max data:%s\n&quot;</span>, optarg);</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;N&#39;</span>:</div>
<div class="line">            hs_properties.client.negotiate_before_key_exchange = 1;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;n&#39;</span>:</div>
<div class="line">            ctx.initial_version = 0xabababa;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;O&#39;</span>:</div>
<div class="line">            suppress_output = 1;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;p&#39;</span>:</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;P&#39;</span>: {</div>
<div class="line">            <span class="keywordflow">if</span> (!validate_path(optarg)) {</div>
<div class="line">                fprintf(stderr, <span class="stringliteral">&quot;invalid path:%s\n&quot;</span>, optarg);</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">            }</div>
<div class="line">            push_req(optarg, opt == <span class="charliteral">&#39;P&#39;</span>);</div>
<div class="line">        } <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;R&#39;</span>:</div>
<div class="line">            enforce_retry = 1;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;r&#39;</span>:</div>
<div class="line">            <span class="keywordflow">if</span> (sscanf(optarg, <span class="stringliteral">&quot;%&quot;</span> SCNu32, &amp;ctx.loss.default_initial_rtt) != 1) {</div>
<div class="line">                fprintf(stderr, <span class="stringliteral">&quot;invalid argument passed to `-r`\n&quot;</span>);</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;S&#39;</span>:</div>
<div class="line">            <span class="keywordflow">if</span> (sscanf(optarg, <span class="stringliteral">&quot;%&quot;</span> SCNu8, &amp;ctx.loss.num_speculative_ptos) != 1) {</div>
<div class="line">                fprintf(stderr, <span class="stringliteral">&quot;invalid argument passed to `-S`\n&quot;</span>);</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;s&#39;</span>:</div>
<div class="line">            session_file = optarg;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;u&#39;</span>:</div>
<div class="line">            <span class="keywordflow">if</span> (sscanf(optarg, <span class="stringliteral">&quot;%&quot;</span> SCNu16, &amp;ctx.initial_egress_max_udp_payload_size) != 1) {</div>
<div class="line">                fprintf(stderr, <span class="stringliteral">&quot;invalid argument passed to `-u`\n&quot;</span>);</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;U&#39;</span>:</div>
<div class="line">            <span class="keywordflow">if</span> (sscanf(optarg, <span class="stringliteral">&quot;%&quot;</span> SCNu64, &amp;ctx.transport_params.max_udp_payload_size) != 1) {</div>
<div class="line">                fprintf(stderr, <span class="stringliteral">&quot;invalid argument passed to `-U`\n&quot;</span>);</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;V&#39;</span>:</div>
<div class="line">            setup_verify_certificate(ctx.tls, NULL);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;v&#39;</span>:</div>
<div class="line">            ++verbosity;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;w&#39;</span>:</div>
<div class="line">            <span class="keywordflow">if</span> (sscanf(optarg, <span class="stringliteral">&quot;%&quot;</span> SCNu32, &amp;ctx.initcwnd_packets) != 1) {</div>
<div class="line">                fprintf(stderr, <span class="stringliteral">&quot;invalid argument passed to `-w`\n&quot;</span>);</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;W&#39;</span>:</div>
<div class="line">            raw_pubkey_file = optarg;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;x&#39;</span>: {</div>
<div class="line">            <span class="keywordtype">size_t</span> i;</div>
<div class="line">            <span class="keywordflow">for</span> (i = 0; key_exchanges[i] != NULL; ++i)</div>
<div class="line">                ;</div>
<div class="line"><span class="preprocessor">#define MATCH(name)                                                 \</span></div>
<div class="line"><span class="preprocessor">    if (key_exchanges[i] == NULL &amp;&amp; strcasecmp(optarg, #name) == 0) \</span></div>
<div class="line"><span class="preprocessor">    key_exchanges[i] = &amp;ptls_openssl_##name</span></div>
<div class="line">            MATCH(secp256r1);</div>
<div class="line"><span class="preprocessor">#if PTLS_OPENSSL_HAVE_SECP384R1</span></div>
<div class="line">            MATCH(secp384r1);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor">#if PTLS_OPENSSL_HAVE_SECP521R1</span></div>
<div class="line">            MATCH(secp521r1);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor">#if PTLS_OPENSSL_HAVE_X25519</span></div>
<div class="line">            MATCH(x25519);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor">#undef MATCH</span></div>
<div class="line">            <span class="keywordflow">if</span> (key_exchanges[i] == NULL) {</div>
<div class="line">                fprintf(stderr, <span class="stringliteral">&quot;unknown key exchange: %s\n&quot;</span>, optarg);</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">            }</div>
<div class="line">        } <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;X&#39;</span>:</div>
<div class="line">            <span class="keywordflow">if</span> (sscanf(optarg, <span class="stringliteral">&quot;%&quot;</span> SCNu64, &amp;ctx.transport_params.max_streams_bidi) != 1) {</div>
<div class="line">                fprintf(stderr, <span class="stringliteral">&quot;failed to parse max streams count: %s\n&quot;</span>, optarg);</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <span class="charliteral">&#39;y&#39;</span>: {</div>
<div class="line">            <span class="keywordtype">size_t</span> i;</div>
<div class="line">            <span class="keywordflow">for</span> (i = 0; cipher_suites[i] != NULL; ++i)</div>
<div class="line">                ;</div>
<div class="line"><span class="preprocessor">#define MATCH(name, engine)                                         \</span></div>
<div class="line"><span class="preprocessor">    if (cipher_suites[i] == NULL &amp;&amp; strcasecmp(optarg, #name) == 0) \</span></div>
<div class="line"><span class="preprocessor">    cipher_suites[i] = &amp;engine##_##name</span></div>
<div class="line"><span class="preprocessor">#if QUICLY_HAVE_FUSION</span></div>
<div class="line">            MATCH(aes128gcmsha256, fusion);</div>
<div class="line">            MATCH(aes256gcmsha384, fusion);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">            MATCH(aes128gcmsha256, ptls_openssl);</div>
<div class="line">            MATCH(aes256gcmsha384, ptls_openssl);</div>
<div class="line"><span class="preprocessor">#if PTLS_OPENSSL_HAVE_CHACHA20_POLY1305</span></div>
<div class="line">            MATCH(chacha20poly1305sha256, ptls_openssl);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor">#undef MATCH</span></div>
<div class="line">            <span class="keywordflow">if</span> (cipher_suites[i] == NULL) {</div>
<div class="line">                fprintf(stderr, <span class="stringliteral">&quot;unknown cipher-suite: %s\n&quot;</span>, optarg);</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">            }</div>
<div class="line">        } <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            usage(argv[0]);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    argc -= optind;</div>
<div class="line">    argv += optind;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (reqs[0].path == NULL)</div>
<div class="line">        push_req(<span class="stringliteral">&quot;/&quot;</span>, 0);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (key_exchanges[0] == NULL)</div>
<div class="line">        key_exchanges[0] = &amp;ptls_openssl_secp256r1;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Amend cipher-suites. Copy the defaults when `-y` option is not used. Otherwise, complain if</span></div>
<div class="line"><span class="comment">     * aes128gcmsha256 is not specified</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <span class="keywordflow">if</span> (cipher_suites[0] == NULL) {</div>
<div class="line">        <span class="keywordtype">size_t</span> i;</div>
<div class="line">        <span class="keywordflow">for</span> (i = 0; ptls_openssl_cipher_suites[i] != NULL; ++i) {</div>
<div class="line">            cipher_suites[i] = ptls_openssl_cipher_suites[i];</div>
<div class="line"><span class="preprocessor">#if QUICLY_HAVE_FUSION</span></div>
<div class="line">            <span class="keywordflow">if</span> (cipher_suites[i]-&gt;<span class="keywordtype">id</span> == PTLS_CIPHER_SUITE_AES_128_GCM_SHA256)</div>
<div class="line">                cipher_suites[i] = &amp;fusion_aes128gcmsha256;</div>
<div class="line">            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cipher_suites[i]-&gt;<span class="keywordtype">id</span> == PTLS_CIPHER_SUITE_AES_256_GCM_SHA384)</div>
<div class="line">                cipher_suites[i] = &amp;fusion_aes256gcmsha384;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">        }</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        <span class="keywordtype">size_t</span> i;</div>
<div class="line">        <span class="keywordflow">for</span> (i = 0; cipher_suites[i] != NULL; ++i) {</div>
<div class="line">            <span class="keywordflow">if</span> (cipher_suites[i]-&gt;<span class="keywordtype">id</span> == PTLS_CIPHER_SUITE_AES_128_GCM_SHA256)</div>
<div class="line">                <span class="keywordflow">goto</span> MandatoryCipherFound;</div>
<div class="line">        }</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;aes128gcmsha256 MUST be one of the cipher-suites specified using `-y`\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    MandatoryCipherFound:;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* make adjustments for datagram frame support */</span></div>
<div class="line">    <span class="keywordflow">if</span> (send_datagram_frame) {</div>
<div class="line">        <span class="keyword">static</span> quicly_receive_datagram_frame_t cb    = {on_receive_datagram_frame};</div>
<div class="line">        ctx.receive_datagram_frame                   = &amp;cb;</div>
<div class="line">        ctx.transport_params.max_datagram_frame_size = ctx.transport_params.max_udp_payload_size;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (cert_file != NULL || ctx.tls-&gt;sign_certificate != NULL) {</div>
<div class="line">        <span class="comment">/* server */</span></div>
<div class="line">        <span class="keywordflow">if</span> (cert_file == NULL || ctx.tls-&gt;sign_certificate == NULL) {</div>
<div class="line">            fprintf(stderr, <span class="stringliteral">&quot;-c and -k options must be used together\n&quot;</span>);</div>
<div class="line">            <span class="keywordflow">return</span> -1;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> (raw_pubkey_file != NULL) {</div>
<div class="line">            ctx.tls-&gt;certificates.list = calloc(1, <span class="keyword">sizeof</span>(*ctx.tls-&gt;certificates.list));</div>
<div class="line">            load_raw_public_key(ctx.tls-&gt;certificates.list, cert_file);</div>
<div class="line">            ctx.tls-&gt;certificates.count  = 1;</div>
<div class="line">            ctx.tls-&gt;use_raw_public_keys = 1;</div>
<div class="line">        } <span class="keywordflow">else</span></div>
<div class="line">            load_certificate_chain(ctx.tls, cert_file);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> (cid_key == NULL) {</div>
<div class="line">            <span class="keyword">static</span> <span class="keywordtype">char</span> random_key[17];</div>
<div class="line">            tlsctx.random_bytes(random_key, <span class="keyword">sizeof</span>(random_key) - 1);</div>
<div class="line">            cid_key = random_key;</div>
<div class="line">        }</div>
<div class="line">        ctx.cid_encryptor = quicly_new_default_cid_encryptor(</div>
<div class="line">            &amp;ptls_openssl_bfecb, &amp;ptls_openssl_aes128ecb, &amp;ptls_openssl_sha256,</div>
<div class="line">            ptls_iovec_init(cid_key, strlen(cid_key)));</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        <span class="comment">/* client */</span></div>
<div class="line">        <span class="keywordflow">if</span> (raw_pubkey_file != NULL) {</div>
<div class="line">            ptls_iovec_t raw_pub_key;</div>
<div class="line">            EVP_PKEY *pubkey;</div>
<div class="line">            load_raw_public_key(&amp;raw_pub_key, raw_pubkey_file);</div>
<div class="line">            pubkey = d2i_PUBKEY(NULL, (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> **)&amp;raw_pub_key.base, raw_pub_key.len);</div>
<div class="line">            <span class="keywordflow">if</span> (pubkey == NULL) {</div>
<div class="line">                fprintf(stderr, <span class="stringliteral">&quot;Failed to create an EVP_PKEY from the key found in %s\n&quot;</span>,</div>
<div class="line">                        raw_pubkey_file);</div>
<div class="line">                <span class="keywordflow">return</span> -1;</div>
<div class="line">            }</div>
<div class="line">            setup_raw_pubkey_verify_certificate(ctx.tls, pubkey);</div>
<div class="line">            EVP_PKEY_free(pubkey);</div>
<div class="line">            ctx.tls-&gt;use_raw_public_keys = 1;</div>
<div class="line">        }</div>
<div class="line">        hs_properties.client.negotiated_protocols.list  = negotiated_protocols.list;</div>
<div class="line">        hs_properties.client.negotiated_protocols.count = negotiated_protocols.count;</div>
<div class="line">        <span class="keywordflow">if</span> (session_file != NULL)</div>
<div class="line">            load_session();</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (argc != 2) {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;missing host and port\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -1;</div>
<div class="line">    }</div>
<div class="line">    host = (--argc, *argv++);</div>
<div class="line">    port = (--argc, *argv++);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (resolve_address((<span class="keywordtype">void</span> *)&amp;cinfo-&gt;sa, &amp;cinfo-&gt;salen, host, port, AF_INET, SOCK_DGRAM,</div>
<div class="line">                        IPPROTO_UDP) != 0)</div>
<div class="line">        <a name="a12"></a><a class="code" href="cne__log_8h.html#ac8c38301b044c47cdcdffa35550bd524">CNE_ERR_RET</a>(<span class="stringliteral">&quot;Unable to resolve host address\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    is_server = ctx.tls-&gt;certificates.count;</div>
<div class="line"> </div>
<div class="line">    strlcpy(cinfo-&gt;host, host, <span class="keyword">sizeof</span>(cinfo-&gt;host));</div>
<div class="line">    strlcpy(cinfo-&gt;dport, port, <span class="keyword">sizeof</span>(cinfo-&gt;dport));</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">open_quic_channel(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    uint32_t opt;</div>
<div class="line">    <span class="keywordtype">int</span> cd;</div>
<div class="line"> </div>
<div class="line">    cd = <a name="a13"></a><a class="code" href="cnet__chnl_8h.html#a68bf1afb55dbd6fb59b05a9c3f088b6f">channel</a>(cinfo-&gt;sa.ss_family, SOCK_DGRAM, 0, quic_callback);</div>
<div class="line">    <span class="keywordflow">if</span> (cd &lt; 0)</div>
<div class="line">        <a name="a14"></a><a class="code" href="cne__log_8h.html#ad8375acbd0957d02439e7b8d7f3a6e22">CNE_ERR_GOTO</a>(err, <span class="stringliteral">&quot;channel() call failed\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    opt = 1;</div>
<div class="line">    <span class="keywordflow">if</span> (<a name="a15"></a><a class="code" href="cnet__chnl__opt_8h.html#aaa0749f638d118156c993f1e5de5564d">chnl_set_opt</a>(cd, SO_CHANNEL, SO_REUSEADDR, &amp;opt, <span class="keyword">sizeof</span>(uint32_t)) &lt; 0)</div>
<div class="line">        <a class="code" href="cne__log_8h.html#ad8375acbd0957d02439e7b8d7f3a6e22">CNE_ERR_GOTO</a>(err, <span class="stringliteral">&quot;Setting Reuseaddr failed\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    opt = 1;</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="cnet__chnl__opt_8h.html#aaa0749f638d118156c993f1e5de5564d">chnl_set_opt</a>(cd, 0, SO_UDP_CHKSUM, &amp;opt, <span class="keyword">sizeof</span>(uint32_t)) &lt; 0)</div>
<div class="line">        <a class="code" href="cne__log_8h.html#ad8375acbd0957d02439e7b8d7f3a6e22">CNE_ERR_GOTO</a>(err, <span class="stringliteral">&quot;Setting UDP checksum failed\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (is_server) {</div>
<div class="line">        <span class="keywordflow">if</span> (<a name="a16"></a><a class="code" href="cnet__chnl_8h.html#a4c1a0264223397137793f50ffa8f20cc">chnl_bind</a>(cd, (<span class="keyword">struct</span> sockaddr *)&amp;cinfo-&gt;sa, cinfo-&gt;salen) &lt; 0)</div>
<div class="line">            <a class="code" href="cne__log_8h.html#ad8375acbd0957d02439e7b8d7f3a6e22">CNE_ERR_GOTO</a>(err, <span class="stringliteral">&quot;bind failed\n&quot;</span>);</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        <span class="keyword">struct </span>sockaddr_in local = {0};</div>
<div class="line">        quicly_conn_t *conn      = NULL;</div>
<div class="line">        <span class="keywordtype">int</span> ret;</div>
<div class="line"> </div>
<div class="line">        local.sin_family = AF_INET;</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code" href="cnet__chnl_8h.html#a4c1a0264223397137793f50ffa8f20cc">chnl_bind</a>(cd, (<span class="keyword">struct</span> sockaddr *)&amp;local, <span class="keyword">sizeof</span>(local)) != 0)</div>
<div class="line">            <a class="code" href="cne__log_8h.html#ad8375acbd0957d02439e7b8d7f3a6e22">CNE_ERR_GOTO</a>(err, <span class="stringliteral">&quot;bind failed to local address\n&quot;</span>);</div>
<div class="line"> </div>
<div class="line">        ret =</div>
<div class="line">            quicly_connect(&amp;conn, &amp;ctx, cinfo-&gt;host, (<span class="keyword">struct</span> sockaddr *)&amp;cinfo-&gt;sa, NULL, &amp;next_cid,</div>
<div class="line">                           resumption_token, &amp;hs_properties, &amp;resumed_transport_params);</div>
<div class="line">        assert(ret == 0);</div>
<div class="line">        ++next_cid.master_id;</div>
<div class="line">        enqueue_requests(conn);</div>
<div class="line">        send_pending(cd, conn);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">err:</div>
<div class="line">    <a name="a17"></a><a class="code" href="cnet__chnl_8h.html#a1aaad35546630b7a0c56440d7eed2650">chnl_shutdown</a>(cd, SHUT_RDWR);</div>
<div class="line">    <span class="keywordflow">return</span> -1;</div>
<div class="line">}</div>
<div class="ttc" id="acne__common_8h_html_a110ce74779a3879ca9ba9167c968cf27"><div class="ttname"><a href="cne__common_8h.html#a110ce74779a3879ca9ba9167c968cf27">__cne_unused</a></div><div class="ttdeci">#define __cne_unused</div><div class="ttdef"><b>Definition:</b> <a href="cne__common_8h_source.html#l00144">cne_common.h:144</a></div></div>
<div class="ttc" id="acne__log_8h_html_a1d0beb10fedcde55b30a10c41e565045"><div class="ttname"><a href="cne__log_8h.html#a1d0beb10fedcde55b30a10c41e565045">CNE_RET</a></div><div class="ttdeci">#define CNE_RET(...)</div><div class="ttdef"><b>Definition:</b> <a href="cne__log_8h_source.html#l00238">cne_log.h:238</a></div></div>
<div class="ttc" id="acne__log_8h_html_ac8c38301b044c47cdcdffa35550bd524"><div class="ttname"><a href="cne__log_8h.html#ac8c38301b044c47cdcdffa35550bd524">CNE_ERR_RET</a></div><div class="ttdeci">#define CNE_ERR_RET(...)</div><div class="ttdef"><b>Definition:</b> <a href="cne__log_8h_source.html#l00250">cne_log.h:250</a></div></div>
<div class="ttc" id="acne__log_8h_html_ad8375acbd0957d02439e7b8d7f3a6e22"><div class="ttname"><a href="cne__log_8h.html#ad8375acbd0957d02439e7b8d7f3a6e22">CNE_ERR_GOTO</a></div><div class="ttdeci">#define CNE_ERR_GOTO(lbl,...)</div><div class="ttdef"><b>Definition:</b> <a href="cne__log_8h_source.html#l00273">cne_log.h:273</a></div></div>
<div class="ttc" id="acnet_8h_html"><div class="ttname"><a href="cnet_8h.html">cnet.h</a></div></div>
<div class="ttc" id="acnet__chnl_8h_html"><div class="ttname"><a href="cnet__chnl_8h.html">cnet_chnl.h</a></div></div>
<div class="ttc" id="acnet__chnl_8h_html_a1aaad35546630b7a0c56440d7eed2650"><div class="ttname"><a href="cnet__chnl_8h.html#a1aaad35546630b7a0c56440d7eed2650">chnl_shutdown</a></div><div class="ttdeci">CNDP_API int chnl_shutdown(int cd, int how)</div><div class="ttdoc">Shutdown a channel connection similar to 'shutdown()'.</div></div>
<div class="ttc" id="acnet__chnl_8h_html_a22022a742413830c3d48d3ffb1474ca9"><div class="ttname"><a href="cnet__chnl_8h.html#a22022a742413830c3d48d3ffb1474ca9">chnl_recv</a></div><div class="ttdeci">CNDP_API int chnl_recv(int cd, pktmbuf_t **mbufs, size_t len)</div></div>
<div class="ttc" id="acnet__chnl_8h_html_a4c1a0264223397137793f50ffa8f20cc"><div class="ttname"><a href="cnet__chnl_8h.html#a4c1a0264223397137793f50ffa8f20cc">chnl_bind</a></div><div class="ttdeci">CNDP_API int chnl_bind(int cd, struct sockaddr *addr, int addrlen)</div><div class="ttdoc">Bind an address to a channel similar to 'bind()'.</div></div>
<div class="ttc" id="acnet__chnl_8h_html_a68bf1afb55dbd6fb59b05a9c3f088b6f"><div class="ttname"><a href="cnet__chnl_8h.html#a68bf1afb55dbd6fb59b05a9c3f088b6f">channel</a></div><div class="ttdeci">CNDP_API int channel(int domain, int type, int proto, chnl_cb_t cb)</div><div class="ttdoc">The routine to create a channel structure similar to 'socket()'.</div></div>
<div class="ttc" id="acnet__chnl_8h_html_aa8eb33f9b15b4992e170214ca214fe33"><div class="ttname"><a href="cnet__chnl_8h.html#aa8eb33f9b15b4992e170214ca214fe33">chnl_sendto</a></div><div class="ttdeci">CNDP_API int chnl_sendto(int cd, struct sockaddr *sa, pktmbuf_t **mbufs, uint16_t nb_mbufs)</div><div class="ttdoc">Send data to a channel similar to 'sendto()'.</div></div>
<div class="ttc" id="acnet__chnl__opt_8h_html"><div class="ttname"><a href="cnet__chnl__opt_8h.html">cnet_chnl_opt.h</a></div></div>
<div class="ttc" id="acnet__chnl__opt_8h_html_aaa0749f638d118156c993f1e5de5564d"><div class="ttname"><a href="cnet__chnl__opt_8h.html#aaa0749f638d118156c993f1e5de5564d">chnl_set_opt</a></div><div class="ttdeci">CNDP_API int chnl_set_opt(int cd, int level, int optname, const void *optval, int optlen)</div><div class="ttdoc">Set a channel option.</div></div>
<div class="ttc" id="acnet__meta_8h_html"><div class="ttname"><a href="cnet__meta_8h.html">cnet_meta.h</a></div></div>
<div class="ttc" id="acnet__netif_8h_html"><div class="ttname"><a href="cnet__netif_8h.html">cnet_netif.h</a></div></div>
<div class="ttc" id="acnet__netlink_8h_html"><div class="ttname"><a href="cnet__netlink_8h.html">cnet_netlink.h</a></div></div>
<div class="ttc" id="ahexdump_8h_html"><div class="ttname"><a href="hexdump_8h.html">hexdump.h</a></div></div>
<div class="ttc" id="ahexdump_8h_html_ad43b85b23d613f2633e4c2daaa2762b1"><div class="ttname"><a href="hexdump_8h.html#ad43b85b23d613f2633e4c2daaa2762b1">cne_hexdump</a></div><div class="ttdeci">CNDP_API void cne_hexdump(FILE *f, const char *title, const void *buf, unsigned int len)</div></div>
<div class="ttc" id="apktdev__api_8h_html_a3b4e99e57c23cbe92863182322cb1d6b"><div class="ttname"><a href="pktdev__api_8h.html#a3b4e99e57c23cbe92863182322cb1d6b">pktdev_buf_alloc</a></div><div class="ttdeci">CNDP_API int pktdev_buf_alloc(int lport_id, pktmbuf_t **bufs, uint16_t nb_bufs)</div></div>
<div class="ttc" id="apktmbuf_8h_html_a034b66bc273e1340547cb7288685ad2f"><div class="ttname"><a href="pktmbuf_8h.html#a034b66bc273e1340547cb7288685ad2f">pktmbuf_data_len</a></div><div class="ttdeci">#define pktmbuf_data_len(m)</div><div class="ttdef"><b>Definition:</b> <a href="pktmbuf_8h_source.html#l00370">pktmbuf.h:370</a></div></div>
<div class="ttc" id="apktmbuf_8h_html_a4c8ba493b2f1752a05f261df112925e4"><div class="ttname"><a href="pktmbuf_8h.html#a4c8ba493b2f1752a05f261df112925e4">pktmbuf_metadata</a></div><div class="ttdeci">static void * pktmbuf_metadata(const pktmbuf_t *m)</div><div class="ttdef"><b>Definition:</b> <a href="pktmbuf_8h_source.html#l01209">pktmbuf.h:1209</a></div></div>
<div class="ttc" id="apktmbuf_8h_html_a77fa2b918e3052b564b228868d58c198"><div class="ttname"><a href="pktmbuf_8h.html#a77fa2b918e3052b564b228868d58c198">pktmbuf_mtod</a></div><div class="ttdeci">#define pktmbuf_mtod(m, t)</div><div class="ttdef"><b>Definition:</b> <a href="pktmbuf_8h_source.html#l00416">pktmbuf.h:416</a></div></div>
<div class="ttc" id="apktmbuf_8h_html_aa27ef3ac37cc4956e9722415637f1cfe"><div class="ttname"><a href="pktmbuf_8h.html#aa27ef3ac37cc4956e9722415637f1cfe">pktmbuf_free_bulk</a></div><div class="ttdeci">static void pktmbuf_free_bulk(pktmbuf_t **mbufs, unsigned int count)</div><div class="ttdef"><b>Definition:</b> <a href="pktmbuf_8h_source.html#l00801">pktmbuf.h:801</a></div></div>
<div class="ttc" id="apktmbuf_8h_html_aa531e514fe3bd73404257ed569170e5b"><div class="ttname"><a href="pktmbuf_8h.html#aa531e514fe3bd73404257ed569170e5b">pktmbuf_write</a></div><div class="ttdeci">static const void * pktmbuf_write(const void *buf, uint32_t len, pktmbuf_t *m, uint32_t off)</div><div class="ttdef"><b>Definition:</b> <a href="pktmbuf_8h_source.html#l01097">pktmbuf.h:1097</a></div></div>
<div class="ttc" id="astructpktmbuf__s_html"><div class="ttname"><a href="structpktmbuf__s.html">pktmbuf_s</a></div><div class="ttdef"><b>Definition:</b> <a href="pktmbuf_8h_source.html#l00102">pktmbuf.h:102</a></div></div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
